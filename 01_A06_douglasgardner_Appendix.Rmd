---
title: "Appendix 3"
subtitle: "Area 06 - Douglas Gardner CU Chum Salmon"
author: "Coastland"
date: "`r Sys.Date()`"
papersize: ledger
geometry: margin = 1.75cm
toc: TRUE
output:
  pdf_document: default
  pescdata.filt_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(echo = TRUE, fig.pos = "!h")
options(knitr.table.format ='pdf' )

library(tidyverse)
library(jtools)
library(kableExtra)
library(flextable)
library(knitr)
library(magick)
library(dendextend)
library(corrplot)
library(ggdendro)
library(ggpubr)

options(scipen=10000)

# Load in objects from Area 6 data prep script

releases <- readRDS("RDS/douglas-gardner_releases.rds")
escdata <- readRDS("RDS/cm_douglasgardner_escdata.rds")
escdata.filtered <- readRDS("RDS/douglasgardner-cm_escdata_filtered.rds")
rps.clean <- readRDS("RDS/douglas-gardner_cm_rpsclean.rds")

```


\newpage

# Study area

## Douglas Gardner CU

![](figures/Douglas gardner chum distances.png)

\newpage

# Summary figures

## Escapement: Raw and filtered stream list

```{r, Bubble plot, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Escapement to all Douglas-Gardner chum streams in the PSE database, by enhancement rank.",echo = FALSE, warning = FALSE, message = FALSE}

escdata.raw<-escdata %>% filter(SPP == "CM" & Area == 6)

ggplot(escdata.raw,aes(x=Year,y=SYS_NM,color=Enhancement_Rank,size=escapement))+
  geom_point(alpha=.5)+
  scale_colour_manual(breaks=c("NONE","LOW","MOD","HIGH"),
                      values=c("grey50","steelblue","darkred","seagreen"))+
  labs(y="Escapement",color="Enhancement",x="Year",size="Escapement")+
  theme_bw()+
  theme(legend.position="bottom")+
  guides(colour = guide_legend(nrow = 4))+
  guides(size = guide_legend(nrow = 4))+ 
  theme(axis.text.y = element_text(size = 6))

#unique(escdata.raw$SYS_NM)
#ggsave("figures/area 6 chum escapement data all.png",dpi=600,height=8,width=7)
```

\newpage

```{r, Facet plot of escapements by enhancement ranking, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 10, fig.width = 8, fig.cap = "Escapement to filtered in analysis streams for Douglas-Gardner chum. Colour shows the stream level enhancement level from the PSE database."}

ggplot(escdata.filtered,aes(x=Year,y=escapement,color=Enhancement_Rank))+
  geom_point()+geom_line()+theme_bw()+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  labs(y="Escapement",color="Enhancement Level",title="Area 6 Escapement (filtered streams)")+
  theme(legend.position="bottom")

#ggsave("figures/area 6 chum escapement filtered streams.png",dpi=600,height=8,width=7)

```

\clearpage

## Douglas Gardner chum: distance from the Kitimat River by system

```{r, Kable of distances by inlet, echo = FALSE, warning = FALSE, message = FALSE, fig.align="center", fig.height = 7, fig.width = 7}

streaminlet <- read_csv("data/douglas gardner stream distances.csv")
streaminlet <- streaminlet[,2:3]%>%arrange(dist_km)

colnames(streaminlet) <- c("Stream", "Dist. from enhancement")

kable(streaminlet, format = "latex",caption="Distance from Kitimat River (major enhancement location for chum systems included in analysis.")

```

\clearpage

## Hatchery Releases: Total and by release site

```{r total releases, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center", fig.height = 6, fig.width = 8, fig.cap = "Total releases in the Douglas Gardner CU."}

#total releases for DG

releases.DG <-releases %>% 
  filter(RELEASE_SITE_NAME%in%c("Bish Cr", "Dala R", "Hirsch Cr", "Kildala R", "Kitimat R"))

totalrel.DG <- releases.DG %>% 
  group_by(RELEASE_YEAR)%>%
  summarise(totreleases=sum(releases))%>%
  mutate(group="Douglas Gardner CU")

#write.csv(totalrel.DG,"data/releases area 6 chum total terminal releases.csv")
#saveRDS(totalrel.DG, "RDS/a06cm_totrel.rds")

ggplot(totalrel.DG,aes(x=RELEASE_YEAR,y=totreleases))+
  geom_col(fill="steelblue",color="black")+
  theme_bw()+
  #geom_smooth(se=FALSE,color="black")+
  labs(x="Release Year",y="Total Releases",title="Douglas Gardner Chum: Total Releases")

#ggsave("figures/releases chum area 6 total terminal.png",dpi=600,height=6,width=6)

#write.csv(totrel,"~/R/PSF hatchery review/analysis/spatial/outputs/Area 25 chum releases totals.csv")
```

\newpage

```{r, Facet plot of all releases in Area 6, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 7, fig.width = 8, fig.cap = "Releases by release site:origin stock for chum in the Douglas Gardner CU."}

species="Chum"
rel.cu.name= "Douglas Gardner CU"

ggplot(releases,aes(x=RELEASE_YEAR,y=releases,color=RELEASE_STAGE_NAME,group=grp))+
  geom_line()+geom_point()+
  scale_color_brewer(palette="Set1")+
  facet_wrap(~`site-stock`,ncol=4)+
  theme_bw()+
  labs(x="Release Year",y="Releases",color="Release Stage",
       title=paste0(species,": ",paste0(rel.cu.name,collapse=" ")),subtitle="Release site:Origin stock")+
  theme(legend.position = "bottom",
        plot.title=element_text(size=8),strip.text=element_text(size=8))

```

\newpage

## Metrics

### Escapement, logged escapement, Z-scores, Pavg, and moving average

```{r metric plots,fig.align="center",fig.height=9,fig.width=9,fig.cap="Various plots for escapement and transformations.",echo=FALSE,warning=FALSE,message=FALSE}
#plot streams by enhancement

p1<-ggplot(escdata.filtered,aes(x=Year,y=escapement,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Escapement",title="Raw Escapement",color="Enhancement Rank")

p2<-ggplot(escdata.filtered,aes(x=Year,y=esc.log,color=Enhancement_Rank,group=SYS_NM))+
 geom_line()+
  theme_bw()+
  labs(y="log(Escapement)",title="Logged Escapement")

p3<-ggplot(escdata.filtered,aes(x=Year,y=z,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  geom_hline(yintercept=0)+
  theme_bw()+
  labs(y="Z-scores (Escapement)",title="Z-scores Escapement")

p4<-ggplot(escdata.filtered,aes(x=Year,y=esc.stand,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Standardized Escapement (pavg)",title="Escapement/Average (Pavg)")

ggarrange(p1,p2,p3,p4,ncol=1,common.legend = TRUE,align='v',legend="bottom")

```

\newpage

### Moving average and LOESS fits

```{r moving average and LOESS plots, echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=5,fig.width=6,fig.cap="Moving average and LOESS fits on logged escapement by enhancement ranking."}
t1<-ggplot(escdata.filtered,aes(x=Year,y=m.ave,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Moving Average",title="Moving-Average",color="Enhancement Rank")

t2<-ggplot(escdata.filtered,aes(x=Year,y=z,color=Enhancement_Rank,group=SYS_NM))+
  geom_smooth(method="loess",se=FALSE,span=.1,linewidth=.7)+
  geom_hline(yintercept=0)+
  theme_bw()+
  labs(y="Z-score",title="Loess fit on Z-scores")

ggarrange(t1,t2,ncol=1,common.legend = TRUE,legend = "bottom",align='v')

mean.z<-escdata.filtered%>%group_by(Enhancement_Rank,Year)%>%summarise(u=mean(z,na.rm=TRUE))
```

\newpage

### Means trends by enhancement rank

```{r means by enhancement rank, echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=7,fig.width=6,fig.cap="Douglas-Gardner chum: Mean Z-score for analysis streams by enhancement rank. Linear regression over all years with SE are shown."}
ggplot(mean.z,aes(x=Year,y=u,color=Enhancement_Rank))+
  geom_line(size=1.5,alpha=.7)+theme_bw()+
  scale_color_brewer(palette = "Set1")+
  labs(y="Mean Z-score")+
  geom_hline(yintercept=0,linetype="dashed")+
  geom_vline(xintercept=1980)+
  facet_wrap(~Enhancement_Rank,ncol=1)+
  geom_smooth(method="lm",color="black")+
  guides(color=FALSE)
  
```

\clearpage

## Recruits per spawners

### Recruits per spawner by system

```{r, Plotting RPS by system, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 7, fig.cap = "Douglas-Gardner chum: recruits per spawner by system."}

# RPS by system

ggplot(rps.clean,aes(x=Year,y=rps))+
  geom_line()+geom_point()+
  geom_smooth(method='lm',se=TRUE,size=.7)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_hline(yintercept=1)

```

\newpage

### Log recruits per spawner by system by period

```{r, Log recruits per spawner by system, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 8, fig.cap = "Douglas-Gardner chum: log recruits per spawner by system fitted with linear regression for the periods pre- and post-enhancement (Aaltanhash to Kildala)."}
#nrow(logrps)
# Log RPS by system
fy=1980

logrps<-rps.clean%>%select(Year,prepost,logrps,SYS_NM)%>%arrange(SYS_NM,prepost,Year)

idx <- c(1, diff(logrps$Year))
i2 <- c(1,which(idx != 1), nrow(logrps)+1)
logrps$grp <- rep(1:length(diff(i2)), diff(i2))

#split into 2 batches
logrps.1 <- logrps[1:930,]
logrps.2 <- logrps[931:nrow(logrps),]

ggplot(logrps.1,aes(x=Year,y=logrps,color=prepost,group=grp))+
  geom_line(alpha=.5)+geom_point(alpha=.5)+
  scale_color_brewer(palette="Set1")+
  geom_smooth(method='lm',se=TRUE)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_vline(xintercept=fy,color="seagreen")+
  geom_hline(yintercept=0,linetype="dashed")+
  labs(x="Brood Year",y="log(Recruits per spawner)",color="Period",title="Area 6 Chum")+
  theme(legend.position="bottom")
```


```{r, Log recruits per spawner by system2, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 8, fig.cap = "Douglas-Gardner chum: log recruits per spawner by system fitted with linear regression for the periods pre- and post-enhancement (Kiltuish to Weewanie)."}

ggplot(logrps.2,aes(x=Year,y=logrps,color=prepost,group=grp))+
  geom_line(alpha=.5)+geom_point(alpha=.5)+
  scale_color_brewer(palette="Set1")+
  geom_smooth(method='lm',se=TRUE)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_vline(xintercept=fy,color="seagreen")+
  geom_hline(yintercept=0,linetype="dashed")+
  labs(x="Brood Year",y="log(Recruits per spawner)",color="Period",title="Area 6 Chum")+
  theme(legend.position="bottom")

#ggsave("figures/area 6 chum log rps pre vs post.png",dpi=600,height=8,width=7)

```

\newpage

### Log RPS comparison before and after enhancement

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 7, fig.width = 8, fig.cap = "Douglas-Gardner chum: boxplot of log recruits per spawner by system."}

ggplot(logrps,aes( y = SYS_NM, x = logrps, fill = prepost))+
  geom_boxplot(notch=F)+
  scale_fill_brewer(palette="Set1")+
  geom_vline(xintercept=0)+
  theme_bw()+
  labs(y="System Name",x="log(recruits per spawner)",title="Area 6 Chum",fill="Period")+
  theme(legend.position="bottom")

#ggsave("figures/area 6 chum log rps pre vs post boxplot.png",dpi=600,height=8,width=7)

```

\newpage

## Bubbleplots of metric by inlet

```{r, Malick and Cox plot z-score, message = FALSE, warning = FALSE, echo = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Escapement by inlet and z-score"}
inlets <- read_csv("data/douglas-gardner subinlets.csv")%>%select(SYS_NM,inlet)

f<-escdata.filtered%>%select(Year,SYS_NM,z)

g<-merge(f,inlets,by="SYS_NM")

range(g$z,na.rm=TRUE)

`Z-score` <- c(-3, -2, -1, 0, 1, 2, 3)
shape <- c(21, 21, 21, 20, 19, 19, 19)
cols <- c("red", "red", "red", "black", "blue", "blue", "blue")
shapelkp <- tibble(`Z-score`, shape, cols)
g$`Z-score` <- as.numeric(substr(g$z, 1, 2))
g$size <- abs(g$z)
g <- merge(shapelkp, g, by = "Z-score")
g$`Z-score` <- as.factor(g$`Z-score`)

ggplot(g, aes(x = Year, y = SYS_NM, shape = `Z-score`, size = `Z-score`, color = `Z-score`, fill = `Z-score`)) +
  geom_point() +
  scale_size_manual(values = c("-3" = 5, "-2" = 3, "-1" = 2, 
                               "0" = 2, 
                               "1" = 2, "2" = 3, "3" = 5))+
  scale_shape_manual(values = c("-3" = 1, "-2" = 1, "-1" = 1, 
                                "0" = 20, 
                                "1" = 21, "2" = 21, "3" = 21)) +
  scale_color_manual(values = c("-3" = "darkred", "-2" = "red4", "-1" = "red1", 
                                "0" = "black", 
                                "1" = "royalblue1", "2" = "royalblue4", "3" = "royalblue4"))+
  scale_fill_manual(values = c("-3" = "darkred", "-2" = "red4", "-1" = "red1", 
                                "0" = "black", 
                                "1" = "royalblue1", "2" = "royalblue4", "3" = "royalblue4"))+
  labs(y="Escapement",x="Year", legend = "Z-score")+
  theme_bw()+
  theme(legend.position="bottom")+
  guides(size=FALSE)+
  theme(axis.text.y = element_text(size = 6))+
  guides(shape = guide_legend(ncol = 7))+ 
  facet_grid(inlet~.,switch="y",space="free_y",scale="free_y")

ggsave("figures/douglas gardner z scores bubble by inlet.png",dpi=600,height=7,width=6)

```

\newpage

```{r, Malick and Cox plot logRPS, message = FALSE, warning = FALSE, echo = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Escapement by inlet and log RPS"}
inlets <- read_csv("data/douglas-gardner subinlets.csv")%>%select(SYS_NM,inlet)

f<-rps.clean%>%select(Year,SYS_NM,logrps)

g<-merge(f,inlets,by="SYS_NM")

range(g$logrps,na.rm=TRUE)

`log RPS` <- c(-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5)
shape <- c(21, 21, 21, 21, 21, 20, 19, 19, 19, 19, 19)
cols <- c("red", "red", "red", "red", "red", "black", "blue", "blue", "blue", "blue", "blue")
shapelkp <- tibble(`log RPS`, shape, cols)
g$`log RPS` <- as.numeric(substr(g$logrps, 1, 2))
g$size <- abs(g$`log RPS`)
g <- merge(shapelkp, g, by = "log RPS")
g$`log RPS` <- as.factor(g$`log RPS`)

ggplot(g, aes(x = Year, y = SYS_NM, shape = `log RPS`, size = `log RPS`, color = `log RPS`, fill = `log RPS`)) +
  geom_point() +
  scale_size_manual(values = c("-5" = 5, "-4" = 4, "-3" = 3, "-2" = 2, "-1" = 1, 
                               "0" = 1, 
                               "1" = 1, "2" = 2, "3" = 3, "4" = 4, "5" = 5))+
  scale_shape_manual(values = c("-5" = 1, "-4" = 1, "-3" = 1, "-2" = 1, "-1" = 1, 
                                "0" = 20, 
                                "1" = 21, "2" = 21, "3" = 21, "4" = 21, "5" = 21)) +
  scale_color_manual(values = c("-5" = "darkred", "-4" = "darkred","-3" = "darkred",
                                "-2" = "red4", "-1" = "red1", 
                                "0" = "black", 
                                "1" = "royalblue1", "2" = "royalblue2", "3" = "royalblue3",
                                "4" = "royalblue4", "5" = "royalblue4"))+
  scale_fill_manual(values = c("-5" = "darkred", "-4" = "darkred",
                               "-3" = "darkred", "-2" = "red4", "-1" = "red1", 
                                "0" = "black", 
                                "1" = "royalblue1", "2" = "royalblue4", "3" = "royalblue4",
                                "4" = "royalblue4", "5" = "royalblue4"))+
  labs(y="Escapement",x="Year")+
  theme_bw()+
  theme(legend.position="bottom")+
  guides(size=FALSE)+
  theme(axis.text.y = element_text(size = 6))+
  guides(shape = guide_legend(ncol = 11, nrow = 2))+ 
  facet_grid(inlet~.,switch="y",space="free_y",scale="free_y")

ggsave("figures/douglas gardner log RPS bubble by inlet.png",dpi=600,height=7,width=6)

```

\clearpage

# Correlation analyses and Dendrograms

## Cross correlation plots

```{r, Correlation analyses, echo = FALSE, message = FALSE, warning = FALSE}

rps.clean <- readRDS("RDS/douglas-gardner_cm_rpsclean.rds")
inlets <- read_csv("data/douglas-gardner subinlets.csv")

rps.clean <- merge(inlets, rps.clean, by = "SYS_NM")

#escdata.filtered <- readRDS("RDS/douglasgardner-cm_escdata_filtered.rds") %>%
#  select(SYS_NM, Year, esc.log, z, m.ave, esc.stand)

cor.data.z<-rps.clean%>%select(SYS_NM,Year,z)%>%
  pivot_wider(names_from="Year",values_from="z")%>%
  data.frame()
rownames(cor.data.z)<-cor.data.z$SYS_NM
cor.data.z<-cor.data.z%>%select(-SYS_NM)
cor.z<-cor(t(cor.data.z),use="pairwise.complete.obs")
dist.cor.z<- dist(cor.z)
clust.dist.cor.z <- hclust(dist.cor.z)
dendclust.z <- dendro_data(clust.dist.cor.z)

cor.data.e<-rps.clean%>%select(SYS_NM,Year,esc.log)%>%
  pivot_wider(names_from="Year",values_from="esc.log")%>%
  data.frame()
rownames(cor.data.e)<-cor.data.e$SYS_NM
cor.data.e<-cor.data.e%>%select(-SYS_NM)
cor.e<-cor(t(cor.data.e),use="pairwise.complete.obs")
dist.cor.e<- dist(cor.e)
clust.dist.cor.e <- hclust(dist.cor.e)
dendclust.e <- dendro_data(clust.dist.cor.e)


cor.data.s<-rps.clean%>%select(SYS_NM,Year,esc.stand)%>%
  pivot_wider(names_from="Year",values_from="esc.stand")%>%
  data.frame()
rownames(cor.data.s)<-cor.data.s$SYS_NM
cor.data.s<-cor.data.s%>%select(-SYS_NM)
cor.s<-cor(t(cor.data.s),use="pairwise.complete.obs")
dist.cor.s<- dist(cor.s)
clust.dist.cor.s <- hclust(dist.cor.s)
dendclust.s <- dendro_data(clust.dist.cor.s)


cor.data.m<-rps.clean%>%select(SYS_NM,Year,m.ave)%>%
  pivot_wider(names_from="Year",values_from="m.ave")%>%
  data.frame()
rownames(cor.data.m)<-cor.data.m$SYS_NM
cor.data.m<-cor.data.m%>%select(-SYS_NM)
cor.m<-cor(t(cor.data.m),use="pairwise.complete.obs")
dist.cor.m<- dist(cor.m)
clust.dist.cor.m <- hclust(dist.cor.m)
dendclust.m <- dendro_data(clust.dist.cor.m)


cor.data.rps<-rps.clean%>%select(SYS_NM,Year,rps)%>%
  pivot_wider(names_from="Year",values_from="rps")%>%
  data.frame()
rownames(cor.data.rps)<-cor.data.rps$SYS_NM
cor.data.rps<-cor.data.rps%>%select(-SYS_NM)
cor.rps<-cor(t(cor.data.rps),use="pairwise.complete.obs")
dist.cor.rps<- dist(cor.rps)
clust.dist.cor.rps <- hclust(dist.cor.rps)
dendclust.rps <- dendro_data(clust.dist.cor.rps)



cor.data.rpslog<-rps.clean%>%select(SYS_NM,Year,logrps)%>%
  pivot_wider(names_from="Year",values_from="logrps")%>%
  data.frame()
rownames(cor.data.rpslog)<-cor.data.rpslog$SYS_NM
cor.data.rpslog<-cor.data.rpslog%>%select(-SYS_NM)
cor.rpslog<-cor(t(cor.data.rpslog),use="pairwise.complete.obs")
dist.cor.rpslog<- dist(cor.rpslog)
clust.dist.cor.rpslog <- hclust(dist.cor.rpslog)
dendclust.rpslog <- dendro_data(clust.dist.cor.rpslog)


```


```{r, Correlation plots by metric, echo = FALSE, message = FALSE, error = FALSE, fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Cross correlation plots to compare metrics."}
par(oma=c(0,0,0,0))
par(mfrow=c(3,2))

corrplot(cor.z, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Z-scores", mar=c(0,0,3,0))
corrplot(cor.e, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Log escapement", mar=c(0,0,3,0))
corrplot(cor.s, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Standardized escapement", mar=c(0,0,3,0))
corrplot(cor.m, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45,title = "Moving average", mar=c(0,0,3,0))
corrplot(cor.rps, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "RPS", mar=c(0,0,3,0))
corrplot(cor.rpslog, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Log RPS", mar=c(0,0,3,0))

```

```{r, Make colour vectors for dendrogram inlets, message=FALSE, warning=FALSE, echo=FALSE, include = FALSE}

zlabs <- as.data.frame(dendclust.z[["labels"]][["label"]])
colnames(zlabs) <- "SYS_NM"
zlabs$order <- c(1:length(zlabs$SYS_NM))
zlabs <- merge(zlabs, rps.clean, by = "SYS_NM")
zlabs <- zlabs %>%
  select(SYS_NM, order, subinlet)
zlabs <- distinct(zlabs)
zlabcols <- as.data.frame(unique(zlabs$subinlet))
colnames(zlabcols) <- "subinlet"
zlabcols <- zlabcols %>%
  arrange(subinlet)
zlabcols$colour <- c("red", "blue", "green", "goldenrod", "black", "turquoise1")
zlabs <- merge(zlabcols, zlabs, by = "subinlet")
zlabs <- zlabs %>%
  arrange(order)
zlabs <- zlabs$colour

elabs <- as.data.frame(dendclust.e[["labels"]][["label"]])
colnames(elabs) <- "SYS_NM"
elabs$order <- c(1:length(elabs$SYS_NM))
elabs <- merge(elabs, rps.clean, by = "SYS_NM")
elabs <- elabs %>%
  select(SYS_NM, order, subinlet)
elabs <- distinct(elabs)
elabcols <- as.data.frame(unique(elabs$subinlet))
colnames(elabcols) <- "subinlet"
elabcols <- elabcols %>%
  arrange(subinlet)
elabcols$colour <- c("red", "blue", "green", "goldenrod", "black", "turquoise1")
elabs <- merge(elabcols, elabs, by = "subinlet")
elabs <- elabs %>%
  arrange(order)
elabs <- elabs$colour

slabs <- as.data.frame(dendclust.s[["labels"]][["label"]])
colnames(slabs) <- "SYS_NM"
slabs$order <- c(1:length(slabs$SYS_NM))
slabs <- merge(slabs, rps.clean, by = "SYS_NM")
slabs <- slabs %>%
  select(SYS_NM, order, subinlet)
slabs <- distinct(slabs)
slabcols <- as.data.frame(unique(slabs$subinlet))
colnames(slabcols) <- "subinlet"
slabcols <- slabcols %>%
  arrange(subinlet)
slabcols$colour <- c("red", "blue", "green", "goldenrod", "black", "turquoise1")
slabs <- merge(slabcols, slabs, by = "subinlet")
slabs <- slabs %>%
  arrange(order)
slabs <- slabs$colour

mlabs <- as.data.frame(dendclust.m[["labels"]][["label"]])
colnames(mlabs) <- "SYS_NM"
mlabs$order <- c(1:length(mlabs$SYS_NM))
mlabs <- merge(mlabs, rps.clean, by = "SYS_NM")
mlabs <- mlabs %>%
  select(SYS_NM, order, subinlet)
mlabs <- distinct(mlabs)
mlabcols <- as.data.frame(unique(mlabs$subinlet))
colnames(mlabcols) <- "subinlet"
mlabcols <- mlabcols %>%
  arrange(subinlet)
mlabcols$colour <- c("red", "blue", "green", "goldenrod", "black", "turquoise1")
mlabs <- merge(mlabcols, mlabs, by = "subinlet")
mlabs <- mlabs %>%
  arrange(order)
mlabs <- mlabs$colour

rpslabs <- as.data.frame(dendclust.rps[["labels"]][["label"]])
colnames(rpslabs) <- "SYS_NM"
rpslabs$order <- c(1:length(rpslabs$SYS_NM))
rpslabs <- merge(rpslabs, rps.clean, by = "SYS_NM")
rpslabs <- rpslabs %>%
  select(SYS_NM, order, subinlet)
rpslabs <- distinct(rpslabs)
rpslabcols <- as.data.frame(unique(rpslabs$subinlet))
colnames(rpslabcols) <- "subinlet"
rpslabcols <- rpslabcols %>%
  arrange(subinlet)
rpslabcols$colour <- c("red", "blue", "green", "goldenrod", "black", "turquoise1")
rpslabs <- merge(rpslabcols, rpslabs, by = "subinlet")
rpslabs <- rpslabs %>%
  arrange(order)
rpslabs <- rpslabs$colour


rpsloglabs <- as.data.frame(dendclust.rpslog[["labels"]][["label"]])
colnames(rpsloglabs) <- "SYS_NM"
rpsloglabs$order <- c(1:length(rpsloglabs$SYS_NM))
rpsloglabs <- merge(rpsloglabs, rps.clean, by = "SYS_NM")
rpsloglabs <- rpsloglabs %>%
  select(SYS_NM, order, subinlet)
rpsloglabs <- distinct(rpsloglabs)
rpsloglabcols <- as.data.frame(unique(rpsloglabs$subinlet))
colnames(rpsloglabcols) <- "subinlet"
rpsloglabcols <- rpsloglabcols %>%
  arrange(subinlet)
rpsloglabcols$colour <- c("red", "blue", "green", "goldenrod", "black", "turquoise1")
rpsloglabs <- merge(rpsloglabcols, rpsloglabs, by = "subinlet")
rpsloglabs <- rpsloglabs %>%
  arrange(order)
rpsloglabs <- rpsloglabs$colour

```

\newpage

## Dendrogram cluster analysis

```{r, Dendrogram plots, echo = FALSE, message = FALSE, warning = FALSE,  fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Dendrogram cluster analysis to compare uses of different metrics. Colours plotted by subinlet; Dala = red; Douglas = blue; Kemano = green; Khutze = yellow; Kitimat arm = black; Quaal = turquoise"}

par(oma=c(0,0,0,0))
par(mfrow=c(3,2))

clust.dist.cor.z[["labels"]] <- str_to_sentence(word(clust.dist.cor.z[["labels"]]))
dendz <- as.dendrogram(clust.dist.cor.z)
dendz %>%
    set("labels_colors", zlabs) %>%
    plot(main = "Z-scores", horiz = TRUE)

clust.dist.cor.e[["labels"]] <- str_to_sentence(word(clust.dist.cor.e[["labels"]]))
dende <- as.dendrogram(clust.dist.cor.e)
dende %>%
    set("labels_colors", elabs) %>%
    plot(main = "Log escapement", horiz = TRUE)

clust.dist.cor.s[["labels"]] <- str_to_sentence(word(clust.dist.cor.s[["labels"]]))
dends <- as.dendrogram(clust.dist.cor.s)
dends %>%
    set("labels_colors", slabs) %>%
    plot(main = "Standardized escapement", horiz = TRUE)

clust.dist.cor.m[["labels"]] <- str_to_sentence(word(clust.dist.cor.m[["labels"]]))
dendm <- as.dendrogram(clust.dist.cor.m)
dendm %>%
    set("labels_colors", mlabs) %>%
    plot(main = "Moving average", horiz = TRUE)

clust.dist.cor.rps[["labels"]] <- str_to_sentence(word(clust.dist.cor.rps[["labels"]]))
dendrps <- as.dendrogram(clust.dist.cor.rps)
dendrps %>%
    set("labels_colors", rpslabs) %>%
    plot(main = "RPS", horiz = TRUE)

clust.dist.cor.rpslog[["labels"]] <- str_to_sentence(word(clust.dist.cor.rpslog[["labels"]]))
dendrpslog <- as.dendrogram(clust.dist.cor.rpslog)
dendrpslog %>%
    set("labels_colors", rpsloglabs) %>%
    plot(main = "Log RPS", horiz = TRUE)
```
\newpage

## Tanglegrams to compare dendrograms

```{r, Tanglegrams z v log, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Tanglegram of z-score vs. logged escapements"}

#png(file = "figures/a06cm_tanglegram_z_v_log.png", width = 2000, height = 3000, pointsize = 36)

par(oma=c(2,2,2,2))
par(mfrow=c(1,1))

tangle1 <- dendlist(dendz, dende)
                                                                                                            
tanglegram(tangle1, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Log escapement", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```

\newpage

```{r, Tanglegrams z vs std. esc, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Tanglegram of z-score vs. standardized escapements"}

#png(file = "figures/a06cm_tanglegram_z_v_stdesc.png", width = 2000, height = 3000, pointsize = 36)

tangle2 <- dendlist(dendz, dends)
                                                                                                            
tanglegram(tangle2, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Standardized escapement", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()
```

\newpage

```{r, Tanglegrams z vs m.ave, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Tanglegram of z-score vs. moving average"}

#png(file = "figures/a06cm_tanglegram_z_v_mave.png", width = 2000, height = 3000, pointsize = 36)

tangle3 <- dendlist(dendz, dendm)
                                                                                                            
tanglegram(tangle3, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Moving average", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```

\newpage

```{r, Tanglegrams z vs logRPS, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Tanglegram of z-score vs. Log RPS"}

#png(file = "figures/a06cm_tanglegram_z_v_mave.png", width = 2000, height = 3000, pointsize = 36)

tangle4 <- dendlist(dendz, dendrpslog)
                                                                                                            
tanglegram(tangle4, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Log RPS", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```

\newpage

## Pre- and post-enhancement correlation analyses

```{r, Pre-1980 z, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Cross correlation plots of z-scores to compare pre- and post-enhancement."}

cor.data.z <-escdata.filtered %>%
  select(SYS_NM,Year,z) %>%
  pivot_wider(names_from="Year",values_from="z") %>%
  data.frame()

cor.data.z.pre<-cor.data.z[,1:26]
rownames(cor.data.z.pre)<-cor.data.z.pre$SYS_NM
cor.data.z.pre<-cor.data.z.pre%>%select(-SYS_NM)
cor.z.pre<-cor(t(cor.data.z.pre),use="pairwise.complete.obs")

cor.data.z.post<-cor.data.z[,c(1,27:62)]
rownames(cor.data.z.post)<-cor.data.z.post$SYS_NM
cor.data.z.post<-cor.data.z.post%>%select(-SYS_NM)
cor.z.post<-cor(t(cor.data.z.post),use="pairwise.complete.obs")

dist.cor.z.pre <- dist(cor.z.pre)
clust.dist.cor.z.pre <- hclust(dist.cor.z.pre)
tanglelabs.z.pre <- as.data.frame(clust.dist.cor.z.pre[["labels"]])
colnames(tanglelabs.z.pre) <- "SYS_NM"
tanglelabs.z.pre$shortnames <- str_to_sentence(word(tanglelabs.z.pre$SYS_NM))
clust.dist.cor.z.pre[["labels"]] <- tanglelabs.z.pre$shortnames
dendz.pre <- as.dendrogram(clust.dist.cor.z.pre)

# Post-1980
cor.data.z.post<-cor.data.z[,1:26]
rownames(cor.data.z.post)<-cor.data.z.post$SYS_NM
cor.data.z.post<-cor.data.z.post%>%select(-SYS_NM)
cor.z.post<-cor(t(cor.data.z.post),use="pairwise.complete.obs")

cor.data.z.post<-cor.data.z[,c(1,27:62)]
rownames(cor.data.z.post)<-cor.data.z.post$SYS_NM
cor.data.z.post<-cor.data.z.post%>%select(-SYS_NM)
cor.z.post<-cor(t(cor.data.z.post),use="pairwise.complete.obs")

dist.cor.z.post <- dist(cor.z.post)
clust.dist.cor.z.post <- hclust(dist.cor.z.post)
tanglelabs.z.post <- as.data.frame(clust.dist.cor.z.post[["labels"]])
colnames(tanglelabs.z.post) <- "SYS_NM"
tanglelabs.z.post$shortnames <- str_to_sentence(word(tanglelabs.z.post$SYS_NM))
clust.dist.cor.z.post[["labels"]] <- tanglelabs.z.post$shortnames
dendz.post <- as.dendrogram(clust.dist.cor.z.post)

par(mfrow=c(2,1))
corrplot(cor.z.pre, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.5, title = "Z-scores (Pre-1980)", cex.main = .7, mar=c(0,0,1,0))
corrplot(cor.z.post, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.5, title = "Z-score (Post-1980)", sub = "Z-scores", cex.main = .7, mar=c(0,0,1,0))


```

\newpage

```{r, z-score tanglegram, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Tanglegram comparing z-scores pre- and post-enhancement (1980)"}
# Dendrogram, factored by inlet, by z-score

#png(file = "figures/tanglegram_1980_z.png", width = 2000, height = 3000, pointsize = 48)

par(mfrow=c(1,1))

# Pre-1980
dist.cor.z.pre <- dist(cor.z.pre)
clust.dist.cor.z.pre <- hclust(dist.cor.z.pre)
tanglelabs.z.pre <- as.data.frame(clust.dist.cor.z.pre[["labels"]])
colnames(tanglelabs.z.pre) <- "SYS_NM"
tanglelabs.z.pre$shortnames <- str_to_sentence(word(tanglelabs.z.pre$SYS_NM))
clust.dist.cor.z.pre[["labels"]] <- tanglelabs.z.pre$shortnames
dendz.pre <- as.dendrogram(clust.dist.cor.z.pre)

# Post-1980
dist.cor.z.post <- dist(cor.z.post)
clust.dist.cor.z.post <- hclust(dist.cor.z.post)
tanglelabs.z.post <- as.data.frame(clust.dist.cor.z.post[["labels"]])
colnames(tanglelabs.z.post) <- "SYS_NM"
tanglelabs.z.post$shortnames <- str_to_sentence(word(tanglelabs.z.post$SYS_NM))
clust.dist.cor.z.post[["labels"]] <- tanglelabs.z.post$shortnames
dendz.post <- as.dendrogram(clust.dist.cor.z.post)

# Tanglegram
tangle.z <- dendlist(dendz.pre, dendz.post)
tanglegram(tangle.z, lab.cex = .8, margin_inner = 3, main = "Z-scores", main_left = "Pre-1980",
           main_right = "Post-1980", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```

\newpage

```{r, compute boxplot zscores, message = FALSE, error = FALSE, echo = FALSE, include = FALSE}

pre<-data.frame(cor.z.pre)
pre$stream1<-rownames(pre)
post<-data.frame(cor.z.post)
post$stream1<-rownames(post)
pre<-pre%>%pivot_longer(1:ncol(pre)-1,names_to="stream2",values_to="cc")%>%
  mutate(cc=replace(cc,cc==1,NA),
         area="DG",period="Pre")
post<-post%>%pivot_longer(1:ncol(post)-1,names_to="stream2",values_to="cc")%>%
  mutate(cc=replace(cc,cc==1,NA),
         area="DG",period="Post")
dg.z<-rbind(pre,post)%>%mutate(metric="Z-score")
u.pre<-mean(pre$cc,na.rm=TRUE)
sd.pre<-sd(pre$cc,na.rm=TRUE)
u.post<-mean(post$cc,na.rm=TRUE)
sd.post<-sd(post$cc,na.rm=TRUE)
u.pre;sd.pre
u.post;sd.post
precc<-pre$cc
postcc<-post$cc
t.test(pre$cc,post$cc)

```

\newpage

```{r, Pre-1980 logrps, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Cross correlation plots of Log RPS to compare pre- and post-enhancement."}

cor.data.logrps <-rps.clean %>%
  select(SYS_NM,Year,logrps) %>%
  pivot_wider(names_from="Year",values_from="logrps") %>%
  data.frame()

cor.data.logrps.pre<-cor.data.logrps[,1:27]
rownames(cor.data.logrps.pre)<-cor.data.logrps.pre$SYS_NM
cor.data.logrps.pre<-cor.data.logrps.pre%>%select(-SYS_NM)
cor.logrps.pre<-cor(t(cor.data.logrps.pre),use="pairwise.complete.obs")

cor.data.logrps.post<-cor.data.logrps[,c(1,28:63)]
rownames(cor.data.logrps.post)<-cor.data.logrps.post$SYS_NM
cor.data.logrps.post<-cor.data.logrps.post%>%select(-SYS_NM)
cor.logrps.post<-cor(t(cor.data.logrps.post),use="pairwise.complete.obs")

dist.cor.logrps.pre <- dist(cor.logrps.pre)
clust.dist.cor.logrps.pre <- hclust(dist.cor.logrps.pre)
tanglelabs.logrps.pre <- as.data.frame(clust.dist.cor.logrps.pre[["labels"]])
colnames(tanglelabs.logrps.pre) <- "SYS_NM"
tanglelabs.logrps.pre$shortnames <- str_to_sentence(word(tanglelabs.logrps.pre$SYS_NM))
#colnames(nameslookup) <- "SYS_NM"
clust.dist.cor.logrps.pre[["labels"]] <- tanglelabs.logrps.pre$shortnames
dendlogrps.pre <- as.dendrogram(clust.dist.cor.logrps.pre)

# Post-1980
cor.data.logrps.post<-cor.data.logrps[,1:26]
rownames(cor.data.logrps.post)<-cor.data.logrps.post$SYS_NM
cor.data.logrps.post<-cor.data.logrps.post%>%select(-SYS_NM)
cor.logrps.post<-cor(t(cor.data.logrps.post),use="pairwise.complete.obs")

cor.data.logrps.post<-cor.data.logrps[,c(1,27:62)]
rownames(cor.data.logrps.post)<-cor.data.logrps.post$SYS_NM
cor.data.logrps.post<-cor.data.logrps.post%>%select(-SYS_NM)
cor.logrps.post<-cor(t(cor.data.logrps.post),use="pairwise.complete.obs")

dist.cor.logrps.post <- dist(cor.logrps.post)
clust.dist.cor.logrps.post <- hclust(dist.cor.logrps.post)
tanglelabs.logrps.post <- as.data.frame(clust.dist.cor.logrps.post[["labels"]])
colnames(tanglelabs.logrps.post) <- "SYS_NM"
tanglelabs.logrps.post$shortnames <- str_to_sentence(word(tanglelabs.logrps.post$SYS_NM))
#colnames(nameslookup) <- "SYS_NM"
clust.dist.cor.logrps.post[["labels"]] <- tanglelabs.logrps.post$shortnames
dendlogrps.post <- as.dendrogram(clust.dist.cor.logrps.post)

par(mfrow=c(2,1))
corrplot(cor.logrps.pre, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.5, title = "Log RPS (Pre-1980)", cex.main = .7, mar=c(0,0,1,0))
corrplot(cor.logrps.post, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.5, title = "Lof RPS (Post-1980)", cex.main = .7, mar=c(0,0,1,0))


```

\newpage

```{r, Log RPS tanglegram, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Tanglegram comparing Log RPS pre- and post-enhancement (1980)"}
# Dendrogram, factored by inlet, by logrps-score

#png(file = "figures/tanglegram_1980_logrps.png", width = 2000, height = 3000, pointsilogrpse = 48)

par(mfrow=c(1,1))

# Pre-1980
dist.cor.logrps.pre <- dist(cor.logrps.pre)
clust.dist.cor.logrps.pre <- hclust(dist.cor.logrps.pre)
tanglelabs.logrps.pre <- as.data.frame(clust.dist.cor.logrps.pre[["labels"]])
colnames(tanglelabs.logrps.pre) <- "SYS_NM"
#tanglelabs.logrps.pre <- merge(tanglelabs.logrps.pre, nameslookup, on = "SYS_NM")
tanglelabs.logrps.pre$shortnames <- str_to_sentence(word(tanglelabs.logrps.pre$SYS_NM))
clust.dist.cor.logrps.pre[["labels"]] <- tanglelabs.logrps.pre$shortnames
dendlogrps.pre <- as.dendrogram(clust.dist.cor.logrps.pre)

# Post-1980
dist.cor.logrps.post <- dist(cor.logrps.post)
clust.dist.cor.logrps.post <- hclust(dist.cor.logrps.post)
tanglelabs.logrps.post <- as.data.frame(clust.dist.cor.logrps.post[["labels"]])
colnames(tanglelabs.logrps.post) <- "SYS_NM"
#tanglelabs.logrps.post <- merge(tanglelabs.logrps.post, nameslookup, on = "SYS_NM")
tanglelabs.logrps.post$shortnames <- str_to_sentence(word(tanglelabs.logrps.post$SYS_NM))
clust.dist.cor.logrps.post[["labels"]] <- tanglelabs.logrps.post$shortnames
dendlogrps.post <- as.dendrogram(clust.dist.cor.logrps.post)

# Tanglegram
tangle.logrps <- dendlist(dendlogrps.pre, dendlogrps.post)
tanglegram(tangle.logrps, lab.cex = .8, margin_inner = 3, main = "Log RPS", main_left = "Pre-1980",
           main_right = "Post-1980", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```


\newpage

```{r, compute boxplot logrps, message = FALSE, error = FALSE, echo = FALSE, include = FALSE}

pre<-data.frame(cor.logrps.pre)
pre$stream1<-rownames(pre)
post<-data.frame(cor.logrps.post)
post$stream1<-rownames(post)
pre<-pre%>%pivot_longer(1:ncol(pre)-1,names_to="stream2",values_to="cc")%>%
  mutate(cc=replace(cc,cc==1,NA),
         area="DG",period="Pre")
post<-post%>%pivot_longer(1:ncol(post)-1,names_to="stream2",values_to="cc")%>%
  mutate(cc=replace(cc,cc==1,NA),
         area="DG",period="Post")
dg.rps<-rbind(pre,post)%>%mutate(metric="log(RPS)")
u.pre<-mean(pre$cc,na.rm=TRUE)
sd.pre<-sd(pre$cc,na.rm=TRUE)
u.post<-mean(post$cc,na.rm=TRUE)
sd.post<-sd(post$cc,na.rm=TRUE)
u.pre;sd.pre
u.post;sd.post
precc<-pre$cc
postcc<-post$cc
t.test(pre$cc,post$cc)

```

\newpage

```{r, Correlation bubbleplot, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}
inlets <- read_csv("data/douglas-gardner subinlets.csv")%>%select(SYS_NM,inlet)
f<-escdata.filtered%>%select(Year,SYS_NM,z)
g<-merge(f,inlets,by="SYS_NM")
ggplot(g,aes(x=Year,y=SYS_NM,size=z,color=z))+
  geom_point(alpha=1)+
  labs(y="Escapement",x="Year",size="Z-score")+
  theme_bw()+
  theme(legend.position="bottom")+
  scale_colour_gradient2(low = "red",mid = "white",high = "green",
    midpoint = 0,
    space = "Lab",
    na.value = "grey50",
    guide = "colourbar")+
  #guides(colour = guide_legend(nrow = 4))+
  guides(size = guide_legend(nrow = 4))+
  theme(axis.text.y = element_text(size = 6))+
  facet_grid(inlet~.,switch="y",space="free_y",scale="free_y")

```

```{r, Correlation plot by z-score distance, echo = FALSE, warning = FALSE, message = FALSE, include = FALSE}

cordist <- as.data.frame(cor.z) %>%
  select(`KITIMAT RIVER`)
cordist$SYS_NM <- rownames(cordist)

streamdist <- streaminlet
colnames(streamdist) <- c("SYS_NM", "dist")

cordist <- merge(streamdist, cordist, by = "SYS_NM")
colnames(cordist) <- c("SYS_NM", "dist", "corcoef")

saveRDS(cordist, "RDS/A06cordist.rds")

ggplot(cordist, aes(x = dist, y = corcoef)) +
  geom_point() +
  ylab("Correlation coefficient") +
  xlab("Distance from Kitimat enhancement (km)")+
  geom_smooth()
```

```{r, Correlation plot by logrps distance, echo = FALSE, warning = FALSE, message = FALSE, include = FALSE}

cordist <- as.data.frame(cor.rpslog) %>%
  select(`KITIMAT RIVER`)
cordist$SYS_NM <- rownames(cordist)

streamdist <- streaminlet
colnames(streamdist) <- c("SYS_NM", "dist")

cordist <- merge(streamdist, cordist, by = "SYS_NM")
colnames(cordist) <- c("SYS_NM", "dist", "corcoef")

saveRDS(cordist, "RDS/A06cordist_logrps.rds")

ggplot(cordist, aes(x = dist, y = corcoef)) +
  geom_point() +
  ylab("Correlation coefficient") +
  xlab("Distance from Kitimat enhancement (km)")+
  geom_smooth()
```

\newpage


```{r, Comparison of Z-score pre- and post-1980, message = FALSE, error = FALSE, echo = FALSE,fig.align = "center", fig.height = 5, fig.width = 6, fig.cap = "Comparison between correlation coefficients for all pairwise combinations of streams using Z-score and log(RPS) over the pre- and post-1980 periods."}

cc.all<-rbind(dg.z,dg.rps)

ggplot(cc.all,aes(x=factor(period,levels=c("Pre","Post")),y=cc,fill=period))+
  geom_boxplot()+
  scale_fill_brewer(palette="Set1",breaks=c("Pre","Post"))+
  xlab("Period")+theme_bw()+
  ylab("Correlation coefficient")+labs(fill="Period")+
  facet_grid(.~metric)

```

\newpage
```{r, Statistical models, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}

rps.clean <- readRDS("RDS/douglas-gardner_cm_rpsclean.rds")

streams <- streaminlet
colnames(streams) <- c("SYS_NM", "dist")

rps.clean <- merge(rps.clean, streams, by = "SYS_NM", all = TRUE)

totrels <- readRDS("RDS/a06cm_totrel.rds")
totrels <- totrels[,1:2]
colnames(totrels) <- c("Year", "totrel")
totrels <- totrels[1:32,]

rps.clean <- merge(rps.clean, totrels, by = "Year", all = TRUE)
rps.clean$totrel[is.na(rps.clean$totrel)] <- 0
rps.clean$totrel.M<-rps.clean$totrel/10e6
# RPS MODELS

#d is distance, y is year, r is releases
d <- glm(logrps ~ dist, 
         data = rps.clean)
summary(d)

y <- glm(logrps ~ Year, 
         data = rps.clean)
summary(y)

r <- glm(logrps ~ totrel, 
         data = rps.clean)
summary(r)

dy <- glm(logrps ~ dist + Year,
         data = rps.clean)
summary(dy)

ry<- glm(logrps ~ totrel + Year,
         data = rps.clean)
summary(ry)

dr <- glm(logrps ~ dist + totrel,
         data = rps.clean)
summary(dr)

dry <- glm(logrps ~ dist + totrel + Year,
         data = rps.clean)
summary(dry)

g <- glm(logrps ~ dist + totrel.M + Year,
         data = rps.clean)
summary(g)

AIC(d,y,r,dy,ry,dr,dry)


# ESCAPEMENT MODELS

e.d <- glm(esc.log ~ dist, 
         data = rps.clean)
summary(e.d)

e.y <- glm(esc.log ~ Year, 
         data = rps.clean)
summary(e.y)

e.r <- glm(esc.log ~ totrel, 
         data = rps.clean)
summary(e.r)

e.dy <- glm(esc.log ~ dist + Year,
         data = rps.clean)
summary(e.dy)

e.dr <- glm(esc.log ~ dist + totrel,
         data = rps.clean)
summary(e.dr)

e.ry <- glm(esc.log ~ totrel + Year,
         data = rps.clean)
summary(e.ry)

e.dry <- glm(esc.log ~ dist + totrel + Year,
         data = rps.clean)
summary(e.dry)

AIC(e.d,e.y,e.r,e.dy,e.dr,e.ry,e.dry)

```

```{r, Model summary tables, echo = FALSE, warning = FALSE, message = FALSE}
candidates <- read_csv("data/area 6 chum candidate models.csv")

rpscands <- candidates %>% filter(Response=="log RPS")

rpsaic <- AIC(d,y,r,dy,dr,ry,dry)
rpsaic$link<-rownames(rpsaic)

rps.cand.AIC<-merge(rpscands,rpsaic)%>%select(-link)%>%arrange(AIC)

esccands <- candidates %>% filter(Response=="log escapement")

escaic <- AIC(e.d,e.y,e.r,e.dy,e.dr,e.ry,e.dry)
escaic$link<-rownames(escaic)

esc.cand.AIC<-merge(esccands,escaic)%>%select(-link)%>%arrange(AIC)

```


\clearpage

# Statistical models

## Candidate Models with AIC scores for log RPS and log escapement


```{r, Log RPS candidate models and AIC selection, echo = FALSE, warning = FALSE, message = FALSE}

kable(rps.cand.AIC, format = "latex",caption="Candidate models for log RPS and distance from enhancement (dist), total releases (totrel), and year, with AIC scores.")%>%
 kable_styling(latex_options = "hold_position")

```


```{r, Log escapement candidate models and AIC selection, echo = FALSE, warning = FALSE, message = FALSE}

kable(esc.cand.AIC, format = "latex",caption="Candidate models for log escapement and distance from enhancement (dist), total releases (totrel), and year, with AIC scores.")%>%
   kable_styling(latex_options = "hold_position")

```


\clearpage

## Effects plots for top model for log RPS

```{r, Effects plot of log RPS against releases to area, message = FALSE, echo = FALSE, warning = FALSE}

effect_plot(dry, pred = totrel, interval = TRUE, plot.points = TRUE, x.label = "Total releases to area", y.label = "Log recruits per spawner")

```

```{r, Effects plot of log RPS against year, message = FALSE, echo = FALSE, warning = FALSE}

effect_plot(dry, pred = Year, interval = TRUE, plot.points = TRUE, x.label = "Year", y.label = "Log recruits per spawner")

```

\newpage

## Effects plots for top model for log escapement

```{r, Effects plot of log escapement against distance, message = FALSE, echo = FALSE, warning = FALSE, fig.height=4}

effect_plot(e.dy, pred = dist, interval = TRUE, plot.points = TRUE, x.label = "Distance from enhancement (km)", y.label = "Log escapement")

```

```{r, Effects plot, message = FALSE, echo = FALSE, warning = FALSE,fig.height=4}

effect_plot(e.dy, pred = Year, interval = TRUE, plot.points = TRUE, x.label = "Year", y.label = "Log escapement")

```
