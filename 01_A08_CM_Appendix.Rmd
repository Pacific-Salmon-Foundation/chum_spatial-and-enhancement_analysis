---
title: "Spatial Analysis Figures"
subtitle: "Area 08 Chum Salmon"
author: "Coastland"
date: "`r Sys.Date()`"
papersize: ledger
geometry: margin = 1.75cm
toc: TRUE
output:
  pdf_document: default
  pescdata.filt_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)


library(tidyverse)
library(jtools)
library(kableExtra)
library(flextable)
library(knitr)
library(magick)
library(dendextend)
library(corrplot)
library(ggdendro)

# Load in objects from area 8 data prep script

releases <- readRDS("RDS/a08cm_releases.rds")
escdata <- readRDS("RDS/a08cm_escdata.rds")
escdata.filtered <- readRDS("RDS/a08cm_escdata_filtered.rds")
rps.clean <- readRDS("RDS/a08cm_rpsclean.rds")

```


\newpage

# Summary statistics

## Bubbleplot of escapement by enhancement rank

```{r, Bubble plot, fig.align = "center", fig.height = 7, fig.width = 6, fig.cap = "Escapement to area streams by enhancement rank.",echo = FALSE, warning = FALSE, message = FALSE}

escdata.raw<-escdata %>% filter(SPP == "CM" & Area == 8)

ggplot(escdata.raw,aes(x=Year,y=SYS_NM,color=Enhancement_Rank,size=escapement))+
  geom_point(alpha=.5)+
  scale_colour_manual(breaks=c("NONE","LOW","MOD","HIGH"),
                      values=c("grey50","steelblue","darkred","seagreen"))+
  labs(y="Escapement",color="Enhancement",x="Year",size="Escapement")+
  theme_bw()+
  theme(legend.position="bottom")

#unique(escdata.raw$SYS_NM)
ggsave("figures/area 8 chum escapement all streams.png",dpi=600,height=8,width=7)
```

\newpage

## Plot of total releases to area

```{r total releases for area 8 terminal not including mcloughlin bay, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center", fig.height = 6, fig.width = 8, fig.cap = "Total releases for Area 8 (not including McLoughlin Bay)"}

#total releases for BC and MB
releases.BCMB<-releases %>% 
  filter(RELEASE_SITE_NAME%in%c("Fish Cr+Airport Ch","Saloompt R","Snootli Cr","Thorsen Cr/CCST","McLoughlin Bay"))

totalrel.BCMB <- releases.BCMB %>% 
  group_by(RELEASE_YEAR)%>%
  summarise(totreleases=sum(releases))%>%
  mutate(group="BC/MB")

#total releases for just MB
releases.MB<-releases %>% 
  filter(RELEASE_SITE_NAME%in%c("McLoughlin Bay"))

totalrel.MB <- releases.MB %>% 
  group_by(RELEASE_YEAR)%>%
  summarise(totreleases=sum(releases))%>%
  mutate(group="MB")

#total releases for just BC
releases.BC<-releases %>% 
  filter(RELEASE_SITE_NAME%in%c("Fish Cr+Airport Ch","Saloompt R","Snootli Cr","Thorsen Cr/CCST"))

totalrel.BC <- releases.BC %>% 
  group_by(RELEASE_YEAR)%>%
  summarise(totreleases=sum(releases))%>%
  mutate(group="BC")

totrel<-rbind(totalrel.BC,totalrel.BCMB,totalrel.MB)

totrelwide<-totrel%>%pivot_wider(names_from="group",values_from="totreleases")

write.csv(totrelwide,"data/releases area 8 chum total terminal releases by group.csv")

ggplot(totrel,aes(x=RELEASE_YEAR,y=totreleases,color=group))+
  geom_point()+geom_line()+
  theme_bw()+
  geom_smooth() +
  labs(x="Release Year",y="Total Releases",title="Area 8 Chum total terminal releases (excludes Mcloughlin Bay)")

#ggsave("figures/releases chum area 8 total terminal.png",dpi=600,height=6,width=6)

#write.csv(totrel,"~/R/PSF hatchery review/analysis/spatial/outputs/Area 25 chum releases totals.csv")
```

\newpage

## Escapement to streams by enhancement rank

```{r, Facet plot of escapements by enhancement ranking, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 7, fig.width = 8, fig.cap = "Facet plot of escapements by enhancement level"}

ggplot(escdata.filtered,aes(x=Year,y=escapement,color=Enhancement_Rank))+
  geom_point()+geom_line()+theme_bw()+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  labs(y="Escapement",color="Enhancement Level",title="Area 8 Escapement (filtered streams)")+
  theme(legend.position="bottom")

ggsave("figures/area 8 chum escapement filtered streams.png",dpi=600,height=8,width=7)

```

\newpage

## Facet plot of all releases in Area 8

```{r, Face plot of all releases in Area 8, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 7, fig.width = 8, fig.cap = "Facet plot of all releases in Area 8"}

species="Chum"
rel.cu.name=c("BELLA COOLA RIVER-LATE","BELLA COOLA-DEAN RIVERS","SPILLER-FITZ HUGH-BURKE")
fy=1980

ggplot(releases,aes(x=RELEASE_YEAR,y=releases,color=RELEASE_STAGE_NAME,group=grp))+
  geom_line()+geom_point()+
  scale_color_brewer(palette="Set1")+
  facet_wrap(~`site-stock`,ncol=4)+
  theme_bw()+
  labs(x="Release Year",y="Releases",color="Release Stage",
       title=paste0(species,": ",paste0(rel.cu.name,collapse=" ")),subtitle="Release site:Origin stock")+
  theme(legend.position = "bottom",
        plot.title=element_text(size=8),strip.text=element_text(size=8))

```

\newpage

## Recruits per spawner by system

```{r, Plotting RPS by system, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 7, fig.width = 8, fig.cap = "Recruits per spawner by system"}

# RPS by system

ggplot(rps.clean,aes(x=Year,y=rps))+
  geom_line()+geom_point()+
  geom_smooth(method='lm',se=TRUE)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_hline(yintercept=1)

```

\newpage

## Log recruits per spawner by system

```{r, Log recruits per spawner by system, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 7, fig.width = 8, fig.cap = "Log recruits per spawner by system"}

# Log RPS by system

logrps<-rps.clean%>%select(Year,prepost,logrps,SYS_NM)%>%arrange(SYS_NM,prepost,Year)

idx <- c(1, diff(logrps$Year))
i2 <- c(1,which(idx != 1), nrow(logrps)+1)
logrps$grp <- rep(1:length(diff(i2)), diff(i2))

ggplot(logrps,aes(x=Year,y=logrps,color=prepost,group=grp))+
  geom_line(alpha=.5)+geom_point(alpha=.5)+
  scale_color_brewer(palette="Set1")+
  geom_smooth(method='lm',se=TRUE)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_vline(xintercept=fy,color="seagreen")+
  geom_hline(yintercept=0,linetype="dashed")+
  labs(x="Brood Year",y="log(Recruits per spawner)",color="Period",title="Area 8 Chum")+
  theme(legend.position="bottom")

ggsave("figures/area 8 chum log rps pre vs post.png",dpi=600,height=8,width=7)

```

\newpage

## Boxplot of log RPS by system

```{r, Boxplot of log RPS by system, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 7, fig.width = 8, fig.cap = "Boxplot of log recruits per spawner by system"}

ggplot(logrps,aes( y = SYS_NM, x = logrps, fill = prepost))+
  geom_boxplot(notch=F)+
  scale_fill_brewer(palette="Set1")+
  geom_vline(xintercept=0)+
  theme_bw()+
  labs(y="System Name",x="log(Recruits per spawner)",title="Area 8 Chum")+
  theme(legend.position="bottom")

ggsave("figures/area 8 chum log rps pre vs post boxplot.png",dpi=600,height=8,width=7)

```

\newpage

# Correlation analyses

```{r, Correlation analyses, echo = FALSE, message = FALSE, warning = FALSE}

rps.clean <- readRDS("RDS/a08cm_rpsclean.rds")

cor.data.z<-rps.clean%>%select(SYS_NM,Year,z)%>%
  pivot_wider(names_from="Year",values_from="z")%>%
  data.frame()
cor.data.z <- cor.data.z[1:15,] # Drop NA row introduced by weighted distances - check here if errors later 
rownames(cor.data.z)<-cor.data.z$SYS_NM
cor.data.z<-cor.data.z%>%select(-SYS_NM)
cor.z<-cor(t(cor.data.z),use="pairwise.complete.obs")
dist.cor.z<- dist(cor.z)
clust.dist.cor.z <- hclust(dist.cor.z)
dendclust.z <- dendro_data(clust.dist.cor.z)


cor.data.e<-rps.clean%>%select(SYS_NM,Year,esc.log)%>%
  pivot_wider(names_from="Year",values_from="esc.log")%>%
  data.frame()
cor.data.e <- cor.data.e[1:15,] # Drop NA row introduced by weighted distances - check here if errors later 
rownames(cor.data.e)<-cor.data.e$SYS_NM
cor.data.e<-cor.data.e%>%select(-SYS_NM)
cor.e<-cor(t(cor.data.e),use="pairwise.complete.obs")
dist.cor.e<- dist(cor.e)
clust.dist.cor.e <- hclust(dist.cor.e)
dendclust.e <- dendro_data(clust.dist.cor.e)


cor.data.s<-rps.clean%>%select(SYS_NM,Year,esc.stand)%>%
  pivot_wider(names_from="Year",values_from="esc.stand")%>%
  data.frame()
cor.data.s <- cor.data.s[1:15,] # Drop NA row introduced by weighted distances - check here if errors later 
rownames(cor.data.s)<-cor.data.s$SYS_NM
cor.data.s<-cor.data.s%>%select(-SYS_NM)
cor.s<-cor(t(cor.data.s),use="pairwise.complete.obs")
dist.cor.s<- dist(cor.s)
clust.dist.cor.s <- hclust(dist.cor.s)
dendclust.s <- dendro_data(clust.dist.cor.s)


cor.data.m<-rps.clean%>%select(SYS_NM,Year,m.ave)%>%
  pivot_wider(names_from="Year",values_from="m.ave")%>%
  data.frame()
cor.data.m <- cor.data.m[1:15,] # Drop NA row introduced by weighted distances - check here if errors later 
rownames(cor.data.m)<-cor.data.m$SYS_NM
cor.data.m<-cor.data.m%>%select(-SYS_NM)
cor.m<-cor(t(cor.data.m),use="pairwise.complete.obs")
dist.cor.m<- dist(cor.m)
clust.dist.cor.m <- hclust(dist.cor.m)
dendclust.m <- dendro_data(clust.dist.cor.m)

```

```{r, Correlation plots by metric, echo = FALSE, message = FALSE, error = FALSE, fig.align = "center", fig.height = 7, fig.width = 8.5, fig.cap = "Cross correlation plots to compare metrics."}
par(oma=c(0,0,0,0))
par(mfrow=c(2,2))

corrplot(cor.z, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Z-scores", mar=c(0,0,3,0))
corrplot(cor.e, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Log escapement", mar=c(0,0,3,0))
corrplot(cor.s, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Standardized escapement", mar=c(0,0,3,0))
corrplot(cor.m, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Moving average", mar=c(0,0,3,0))

```

\newpage

# Dendrogram clusters analysis

```{r, Dendrogram plots, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Dendrogram cluster analysis to compare uses of different metrics."}

par(oma=c(0,0,0,0))
par(mfrow=c(2,2))

clust.dist.cor.z[["labels"]] <- str_to_sentence(word(clust.dist.cor.z[["labels"]]))
dendz <- as.dendrogram(clust.dist.cor.z)
dendz %>%
    #set("labels_colors", subinlet) %>%
    plot(main = "Z-scores", horiz = TRUE)

clust.dist.cor.e[["labels"]] <- str_to_sentence(word(clust.dist.cor.e[["labels"]]))
dende <- as.dendrogram(clust.dist.cor.e)
dende %>%
    #set("labels_colors", subinlet) %>%
    plot(main = "Log escapement", horiz = TRUE)

clust.dist.cor.s[["labels"]] <- str_to_sentence(word(clust.dist.cor.s[["labels"]]))
dends <- as.dendrogram(clust.dist.cor.s)
dends %>%
    #set("labels_colors", subinlet) %>%
    plot(main = "Standardized escapement", horiz = TRUE)

clust.dist.cor.m[["labels"]] <- str_to_sentence(word(clust.dist.cor.m[["labels"]]))
dendm <- as.dendrogram(clust.dist.cor.m)
dendm %>%
    #set("labels_colors", subinlet) %>%
    plot(main = "Moving average", horiz = TRUE)
```

\newpage

## Tanglegrams

```{r, Tanglegrams, echo = FALSE, message = FALSE, warning = FALSE}

#png(file = "figures/a06cm_tanglegram_z_v_log.png", width = 2000, height = 3000, pointsize = 36)

par(oma=c(2,2,2,2))
par(mfrow=c(1,1))

tangle1 <- dendlist(dendz, dende)
                                                                                                            
tanglegram(tangle1, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Log escapement", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

#png(file = "figures/a06cm_tanglegram_z_v_log.png", width = 2000, height = 3000, pointsize = 36)

par(oma=c(2,2,2,2))
par(mfrow=c(1,1))

tangle2 <- dendlist(dendz, dends)
                                                                                                            
tanglegram(tangle2, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Standardized escapement", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

#png(file = "figures/a06cm_tanglegram_z_v_log.png", width = 2000, height = 3000, pointsize = 36)

par(oma=c(2,2,2,2))
par(mfrow=c(1,1))

tangle3 <- dendlist(dendz, dendm)
                                                                                                            
tanglegram(tangle3, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Moving average", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```


\newpage

# Statistical models

```{r, Statistical models, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}

rps.clean <- readRDS("RDS/a08cm_rpsclean.rds")

rps.clean$SYS_NM <- as.factor(rps.clean$SYS_NM)
rps.clean$subinlet <- as.factor(rps.clean$subinlet)

# RPS MODELS

# log rps ~ dist_km_bel + dist_km_mcl
a <- glm(logrps ~ dist_km_bel + dist_km_mcl, 
         data = rps.clean)
summary(a)

# log rps ~ dist_km_bel + dist_km_mcl + Year + subinlet
b <- glm(logrps ~ dist_km_bel + dist_km_mcl + Year + subinlet, 
         data = rps.clean)
summary(b)

# log rps ~ dist_km_bel + dist_km_mcl + Year + SYS_NM
c <- glm(logrps ~ dist_km_bel + dist_km_mcl + Year + SYS_NM, 
         data = rps.clean)
summary(c)

# log rps ~ dist_km_bel + dist_km_mcl + Year
d <- glm(logrps ~ dist_km_bel + dist_km_mcl + Year, 
         data = rps.clean)
summary(d)

AIC(a, b, c, d)




# ESCAPEMENT MODELS

# log rps ~ dist_km_bel + dist_km_mcl
ea <- glm(esc.log ~ dist_km_bel + dist_km_mcl, 
         data = rps.clean)
summary(ea)

# log rps ~ dist_km_bel + dist_km_mcl + Year + subinlet
eb <- glm(esc.log ~ dist_km_bel + dist_km_mcl + Year + subinlet, 
         data = rps.clean)
summary(eb)

# log rps ~ dist_km_bel + dist_km_mcl + Year + SYS_NM
ec <- glm(esc.log ~ dist_km_bel + dist_km_mcl + Year + SYS_NM, 
         data = rps.clean)
summary(ec)

# log rps ~ dist_km_bel + dist_km_mcl + Year
ed <- glm(esc.log ~ dist_km_bel + dist_km_mcl + Year, 
         data = rps.clean)
summary(ed)

AIC(ea, eb, ec, ed)





# RPS MODELS ON WEIGHTED DISTANCE

# log rps ~ dist_km_bel + dist_km_mcl
wa <- glm(logrps ~ wt_dist_bel + wt_dist_mcl, 
         data = rps.clean)
summary(wa)

# log rps ~ dist_km_bel + dist_km_mcl + Year + subinlet
wb <- glm(logrps ~ wt_dist_bel + wt_dist_mcl + Year + subinlet, 
         data = rps.clean)
summary(wb)

# log rps ~ dist_km_bel + dist_km_mcl + Year + SYS_NM
wc <- glm(logrps ~ wt_dist_bel + wt_dist_mcl + Year + SYS_NM, 
         data = rps.clean)
summary(wc)

# log rps ~ dist_km_bel + dist_km_mcl + Year
wd <- glm(logrps ~ wt_dist_bel + wt_dist_mcl + Year, 
         data = rps.clean)
summary(wd)

AIC(wa, wb, wc, wd)






# ESCAPEMENT MODELS ON WEIGHTED DISTANCE

# log rps ~ dist_km_bel + dist_km_mcl
wea <- glm(esc.log ~ wt_dist_bel + wt_dist_mcl, 
         data = rps.clean)
summary(wea)

# log rps ~ dist_km_bel + dist_km_mcl + Year + subinlet
web <- glm(esc.log ~ wt_dist_bel + wt_dist_mcl + Year + subinlet, 
         data = rps.clean)
summary(web)

# log rps ~ dist_km_bel + dist_km_mcl + Year + SYS_NM
wec <- glm(esc.log ~ wt_dist_bel + wt_dist_mcl + Year + SYS_NM, 
         data = rps.clean)
summary(wec)

# log rps ~ dist_km_bel + dist_km_mcl + Year
wed <- glm(esc.log ~ wt_dist_bel + wt_dist_mcl + Year, 
         data = rps.clean)
summary(wed)

AIC(wea, web, wec, wed)

```


```{r, Model summary tables, echo = FALSE, warning = FALSE, message = FALSE}
candidates <- read_csv("data/area 8 chum candidate models.csv")

rpscands <- as.data.frame(rbind(candidates[1:4,], candidates[9:12,]))
esccands <- as.data.frame(rbind(candidates[5:8,], candidates[13:16,]))

rpsaic <- AIC(a, b, c, d, wa, wb, wc, wd)
escaic <- AIC(ea, eb, ec, ed, wea, web, wec, wed)

rpscands$df <- rpsaic$df
rpscands$AIC <- rpsaic$AIC

esccands$df <- escaic$df
esccands$AIC <- escaic$AIC


#rpscands %>%
#  kable_paper(full_width = F, html_font = "Courier New") %>%
#  kable_styling(latex_options = "HOLD_position")


#pl1 <- as_image(rpscands)


#esccands %>%
#  kable_classic(full_width = F, html_font = "Courier New")
```

\newpage

```{r, Effects plots, message = FALSE, echo = FALSE, warning = FALSE}

#effect_plot(wd, pred = releases_mcl, interval = TRUE, plot.points = TRUE)


```
