---
title: "Spatial Analysis Figures"
author: "Coastland"
date: "22/10/2021"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
#load libraries
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(tidyverse)
library(corrplot)
library(ggpubr)
library(zoo)

options(scipen=10000)

```


```{r functions, echo=FALSE,message=FALSE,warning=FALSE}
#function to extract data and group it
getridofggplotlinesbetweenpoints<-function(data,colstokeep,yearcolumnname) {

d2<-data%>%select(year=yearcolumnname,colstokeep)

idx <- c(1, diff(d2$year))
i2 <- c(1,which(idx != 1), nrow(d2)+1)
d2$grp <- rep(1:length(diff(i2)), diff(i2))
d2
}
```

```{r load prep data, echo=FALSE,message=FALSE,warning=FALSE}
#load escapement data and remove 0's
escdata<-fread("~/R/PSF Hatchery Review/PSE Data/esc-WCVI-with-enhancement-rankings.csv")%>%
  select(-V1)

escdata$escapement[escdata$escapement==0]<-NA

```

```{r add analyses,echo=FALSE,warning=FALSE,message=FALSE}
#filter species and area
species="CM"
area=25
esc.data<-escdata%>%filter(SPP==species&Area==area)

#apply filter - in this case need n counts out of all years
n=(2018-1953)/2

included.stream.list<-esc.data%>%
  group_by(SYS_NM)%>%
  summarise(notnas=sum(!is.na(escapement)))%>%
  filter(notnas>n)

#add escapement metrics and pre/post field
df<-esc.data%>%filter(SYS_NM%in%included.stream.list$SYS_NM)%>%
  group_by(SYS_NM)%>%
  arrange(SYS_NM,Year)%>%
  mutate(esc.log=log(escapement),
         z=(esc.log-mean(esc.log,na.rm=TRUE))/sd(esc.log,na.rm=TRUE),
         m.ave=rollapply(esc.log,4,mean,align='right',fill=NA),
         esc.stand=esc.log/mean(esc.log,na.rm=TRUE),
         prepost=case_when(Year<1980~"Pre",
                           Year>=1980~"Post"))
  
```


```{r correlations for all metrics,echo=FALSE,warning=FALSE,message=FALSE}
#prep data for correlations

cor.data.z<-df%>%select(SYS_NM,Year,z)%>%pivot_wider(names_from="Year",values_from="z")%>%data.frame()

rownames(cor.data.z)<-cor.data.z$SYS_NM

cor.data.z<-cor.data.z%>%select(-SYS_NM)

cor.z<-cor(t(cor.data.z),use="pairwise.complete.obs")


#insert cor analysis for each other metric
#esc.log
#esc.stand
#m.ave
```

\newpage

```{r escapement bubble plot, fig.align="center",fig.height=8,fig.width=6,fig.cap="Escapement to area streams by enhancement rank.",echo=FALSE,warning=FALSE,message=FALSE}
#bubbleplot of escapements for whole area
ggplot(df,aes(x=Year,y=SYS_NM,color=Enhancement_Rank,size=escapement))+
  geom_point(alpha=.5)+
  scale_colour_manual(breaks=c("NONE","LOW","HIGH"),
                      values=c("grey50","steelblue","darkred"))+
  labs(y="Escapement",color="Enhancement",x="Year",size="Escapement")+
  theme_bw()+
  theme(legend.position="bottom")
```

\newpage

```{r metric plots,fig.align="center",fig.height=8,fig.width=6,fig.cap="Various plots for escapement and transformations.",echo=FALSE,warning=FALSE,message=FALSE}
#plot streams by enhancement

p1<-ggplot(df,aes(x=Year,y=escapement,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Escapement",title="Raw Escapement")

p2<-ggplot(df,aes(x=Year,y=esc.log,color=Enhancement_Rank,group=SYS_NM))+
 geom_line()+
  theme_bw()+
  labs(y="log(Escapement)",title="Logged Escapement")

p3<-ggplot(df,aes(x=Year,y=z,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  geom_hline(yintercept=0)+
  theme_bw()+
  labs(y="Z-scores (Escapement)",title="Z-scores Escapement")

p4<-ggplot(df,aes(x=Year,y=esc.stand,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Standardized Escapement (pavg)",title="Escapement/Average (Pavg)")

ggarrange(p1,p2,p3,p4,ncol=1,common.legend = TRUE)

```

\newpage

```{r moving average and LOESS plots, echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=5,fig.width=6,fig.cap="Moving average and LOESS fits on logged escapement by enhancement ranking."}
t1<-ggplot(df,aes(x=Year,y=m.ave,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Moving Average",title="Moving-Average")

t2<-ggplot(df,aes(x=Year,y=z,color=Enhancement_Rank,group=SYS_NM))+
  geom_smooth(method="loess",se=FALSE,span=.1,size=.7)+
  geom_hline(yintercept=0)+
  theme_bw()+
  labs(y="Z-score",title="Loess fit on Z-scores")

ggarrange(t1,t2,ncol=1,common.legend = TRUE)

```

\newpage

```{r prepost boxplot,echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=7,fig.width=6,fig.cap="Z-scores pre- and post-enhancement."}
ggplot(df,aes(y=SYS_NM,x=z,fill=prepost))+
  geom_boxplot()+
  geom_vline(xintercept=0)+
  theme_bw()+
  labs(y="System Name",x="Z-score")
```

\newpage

```{r coorrelation plots, echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=7,fig.width=6,fig.cap="Escapement to area streams by enhancement rank."}
c1<-corrplot(cor.z,diag=FALSE,order="hclust",addrect=6,method="square",tl.col="black",tl.cex=.5)

c2<-corrplot(cor.z,diag=FALSE,order="hclust",addrect=6,method="square",tl.col="black",tl.cex=.5)

ggarrange(c1,c2,common.legend = TRUE,ncol=1)


```




```{r, include=FALSE,eval=FALSE}

rel<-fread("~/R/PSF hatchery review/releases/AllSEPReleases_2020-04-21_Original.csv")

names(rel)
str(rel)

allreleases<-rel%>%select(SPECIES_NAME,STOCK_NAME,FACILITY_NAME,RELEASE_SITE_NAME,RELEASE_STAGE_NAME,TotalRelease,RELEASE_YEAR)%>%
  group_by(SPECIES_NAME,STOCK_NAME,RELEASE_SITE_NAME,FACILITY_NAME,RELEASE_STAGE_NAME,RELEASE_YEAR)%>%
  summarise(releases=sum(as.numeric(TotalRelease)),n=n())

cd<-allreleases%>%filter(SPECIES_NAME=="Chum")

getall<-unique(c(grep("Conuma",cd$RELEASE_SITE_NAME),
          grep("Conuma",cd$STOCK_NAME),
          grep("Canton",cd$RELEASE_SITE_NAME),
          grep("Canton",cd$STOCK_NAME),
          grep("Sucwoa",cd$RELEASE_SITE_NAME),
          grep("Sucwoa",cd$STOCK_NAME),
          grep("Tlupana",cd$RELEASE_SITE_NAME),
          grep("Tlupana",cd$STOCK_NAME),
          grep("Zeballos",cd$RELEASE_SITE_NAME),
          grep("Zeballos",cd$STOCK_NAME)))
          
a26.rel.prep<-cd[getall,]

ggplot(a26.rel.prep,aes(x=RELEASE_YEAR,y=releases,color=RELEASE_STAGE_NAME))+
  geom_point()+geom_line()+
  facet_grid(RELEASE_SITE_NAME~STOCK_NAME)+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(a26.rel.prep,aes(x=RELEASE_YEAR,y=releases,color=RELEASE_STAGE_NAME,shape=STOCK_NAME))+
  geom_point()+geom_line()+
  facet_wrap(~RELEASE_SITE_NAME,scale="free_y",ncol=1)+
  theme_bw()+
  theme(legend.position = "bottom")
```


```{r,include=FALSE,eval=FALSE}
cd%>%filter(RELEASE_SITE_NAME)

atup<-cd%>%filter(RELEASE_SITE_NAME=="Atnarko R Up"&SPECIES_NAME=="Chinook")
atlow<-cd%>%filter(RELEASE_SITE_NAME=="Atnarko R Low"&SPECIES_NAME=="Chinook")
#nimp<-cd%>%filter(RELEASE_SITE_NAME=="Nimpkish R"&SPECIES_NAME=="Chinook")
kitimat<-cd%>%filter(RELEASE_SITE_NAME=="Kitimat R"&SPECIES_NAME=="Chinook")

nimpCN<-cd%>%filter(RELEASE_SITE_NAME=="Nimpkish R"&SPECIES_NAME=="Chinook")
nimpall<-cd%>%filter(RELEASE_SITE_NAME=="Nimpkish R")
atn<-rbind(atup,atlow)

ggdata<-kitimat

idx <- c(1, diff(ggdata$RELEASE_YEAR))
i2 <- c(1,which(idx != 1), nrow(ggdata)+1)
#adds a grouping column for ggplot to use
ggdata$grp <- rep(1:length(diff(i2)), diff(i2))


ggplot(ggdata,aes(x=RELEASE_YEAR,y=releases,color=RELEASE_STAGE_NAME,shape=RELEASE_SITE_NAME,group=grp))+
  geom_line()+
  geom_point()+
  #facet_wrap(~STOCK_NAME+SPECIES_NAME,ncol=2,scales="free_y")+
  facet_wrap(~STOCK_NAME,ncol=1,scales="free_y")+
  #facet_grid(STOCK_NAME~SPECIES_NAME,scales="free_y")+
  labs(y="Releases",x="Release Year",color="Release Stage",shape="Release Site Name")+
  theme_bw()+
  theme(legend.position="bottom",legend.box = "vertical")

ggsave("Nimpkish CN only releases facet grid.png",dpi=600,height=10,width=8)
```

```{r old code,include=FALSE,eval=FALSE}
#included systems
dfwide<-df%>%select(SYS_NM,Enhancement_Rank,Year,escapement)%>%
  pivot_wider(names_from="Year",values_from="escapement")

#count number of observations in last 10 years
dfwide$n10<-apply(dfwide[,3:70],1,function(x) x=sum(!is.na(x[61:71])))

#run a filter to exclude any stream with less than 3 counts in last 10 years
esc.incl1<-subset(dfwide,n10>3)

##standardized escapements
esc.s<-esc.incl1

esc.s$u.esc<-apply(esc.s[3:71],1,function(x) mean(x,na.rm=TRUE))

esc.s[3:71]<-esc.s[3:71]/esc.s$u.esc

#setup for cross correlation
esc.cm<-esc.s%>%select(-n10,-u.esc,-Enhancement_Rank)%>%data.frame()

rownames(esc.cm)<-esc.cm$SYS_NM

cm<-cor(t(esc.cm[,-1]),use="complete.obs")

corrplot(cm,type="upper",order="hclust",method="square",tl.col="black")

#logged escapements
names(esc.incl1)

esc.log<-esc.incl1
esc.log[,3:71] <-log(esc.log[3:71],2)

esc.log2<-esc.log%>%select(-n10,-Enhancement_Rank)%>%data.frame()

rownames(esc.log2)<-esc.log2$SYS_NM


df%>%group_by(SYS_NM)%>%filter(Year>2008)%>%summarise(x=sum(!is.na(escapement)))

```

