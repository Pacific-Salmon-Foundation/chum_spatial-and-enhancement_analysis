---
title: "Appendix 1"
subtitle: "Area 25 Chum Salmon"
author: "Coastland"
date: "`r Sys.Date()`"
papersize: ledger
geometry: margin = 1.75cm
toc: TRUE
output:
  pdf_document: default
  pescdata.filt_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
#load libraries
knitr::opts_chunk$set(echo = TRUE, fig.pos = "!h")
options(knitr.table.format ='pdf' ) 

library(data.table)
library(tidyverse)
library(corrplot)
library(ggpubr)
library(zoo)
library(ggdendro)
library(dendextend)
library(kableExtra)
library(tinytex)

options(scipen=10000)

rps.clean <- readRDS("RDS/a25cm_rps.clean.rds")
pairwise <- read_csv("data/a25pairwise_matrix.csv")

```

\newpage

# Study area

## Area 25 Chum streams

![](figures/area 25 chum stream distances.png)

```{r functions, echo=FALSE,message=FALSE,warning=FALSE}
#function to extract data and group it

getridofggplotlinesbetweenpoints<-function(data,colstokeep,yearcolumnname) {
  d2<-data%>%select(year=yearcolumnname,colstokeep)
  idx <- c(1, diff(d2$year))
  i2 <- c(1,which(idx != 1), nrow(d2)+1)
  d2$grp <- rep(1:length(diff(i2)), diff(i2))
  d2
}
```

\newpage

```{r load escapement data,echo=FALSE}

escdata.raw<-fread("data/area 25 escapement data all.csv")
escdata.filt<-fread("data/area 25 escapement data filtered.csv")%>%select(-V1)

```

# Summary statistics 

## Bubbleplot of escapement by enhancement rank

```{r escapement bubble plot, fig.align="center",fig.height=8,fig.width=6,fig.cap="Escapement to all Area 8 chum streams in the PSE database.",echo=FALSE,warning=FALSE,message=FALSE}

par(mfrow = c(1, 1))
#bubbleplot of escapements for whole area
ggplot(escdata.raw,aes(x=Year,y=SYS_NM,color=Enhancement_Rank,size=escapement))+
  geom_point(alpha=.5)+
  scale_colour_manual(breaks=c("NONE","LOW","HIGH"),
                      values=c("grey50","steelblue","darkred"))+
  labs(y="Escapement",color="Enhancement",x="Year",size="Escapement")+
  theme_bw()+
  theme(legend.position="bottom")+
  guides(colour = guide_legend(nrow = 4))+
  guides(size = guide_legend(nrow = 4))+ 
  theme(axis.text.x = element_text(size = 7))

```

\newpage 

```{r escapement filtered streams only, fig.align="center",fig.height=8,fig.width=7,fig.cap="Escapement to all streams for Area 25 chum. Colour shows the stream enhancement level from the PSE database.",echo=FALSE,warning=FALSE,message=FALSE}

ggplot(escdata.filt,aes(x=Year,y=escapement,color=Enhancement_Rank))+
  geom_point()+geom_line()+theme_bw()+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  labs(y="Escapement",color="Enhancement Level", title = "Area 25 Escapement")+
  theme(legend.position="bottom")

```



\newpage


```{r, Kable of distances by inlet, echo = FALSE, warning = FALSE, message = FALSE, fig.align="center", fig.height = 7, fig.width = 7}

streaminlet <- fread("data/CM A25 filtered stream list_with inlets.csv")


streaminlet <- read_csv("data/CM A25 filtered stream list_with inlets.csv")
streaminlet <- streaminlet[,c(1,5)]

colnames(streaminlet) <- c("Stream", "Dist. from enhancement")

kable(streaminlet, format = "latex",caption="Distance from Conuma River (major enhancement location for chum systems included in analysis)")%>%
      kable_styling(latex_options = "hold_position")


#colnames(streaminlet) <- c("System name", "NOTNAS", "Inlet", "Subinlet", "Dist. from enhancement")
#colaligns <- c("l", "c", "l", "l", "r")
#streaminlet$`System name` <- str_to_title(streaminlet$`System name`)
#streaminlet$Inlet <- str_to_sentence(streaminlet$Inlet)
#streaminlet$Subinlet <- str_to_sentence(streaminlet$Subinlet)

#streaminlet %>%
#  kbl(align = colaligns, format.args = list(big.mark = ",")) %>%
#  kable_paper(full_width = F, html_font = "Courier New") %>%
#  kable_styling(latex_options = "HOLD_position")

```

\newpage

## Hatchery releases to area
```{r releases for area 25, fig.align="center", fig.height=5, fig.width=8, fig.cap="Total hatchery chum salmon releases in Area 25",echo=FALSE,warning=FALSE,message=FALSE}

releases.raw <- read_csv("data/Area 25 chum releases totals.csv")

ggplot(releases.raw, aes(x = RELEASE_YEAR, y = totreleases/1000000)) + 
  geom_point() +
  geom_col(fill="steelblue",color="black") +
  labs(x="Release Year",y="Total Releases (millions)",title="Area 8 Chum total terminal releases")+
  theme_bw()
```

\newpage

## Releases by system

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height=7,fig.width=7,fig.cap="Chum releases to Area 25 by release site and release stage."}

swvi.chum<-fread("data/swvi chum releases filtered.csv")

ggdata.rel <- swvi.chum
ggdata.rel <- ggdata.rel[,2:13]

idx <- c(1, diff(ggdata.rel$RELEASE_YEAR))
i2 <- c(1,which(idx != 1), nrow(ggdata.rel)+1)
ggdata.rel$grp <- rep(1:length(diff(i2)), diff(i2))

ggplot(ggdata.rel,aes(x=RELEASE_YEAR,y=releases,color=RELEASE_STAGE_NAME,group=grp))+
  geom_line()+
  geom_point(size = 0.7)+
  scale_color_brewer(palette="Set1")+
  facet_wrap(~`site-stock`,ncol=3)+
  theme_bw()+
  labs(x="Release Year",y="Releases",color="Release Stage")+
  theme(legend.position = "bottom")

```

\newpage

## Metrics

### Escapement, logged escapement, Z-scores, Pavg, and moving average

```{r metric plots,fig.align="center",fig.height=8,fig.width=6,fig.cap="Various plots for escapement and transformations.",echo=FALSE,warning=FALSE,message=FALSE}
#plot streams by enhancement

p1<-ggplot(escdata.filt,aes(x=Year,y=escapement,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Escapement",title="Raw Escapement",color="Enhancement Rank")

p2<-ggplot(escdata.filt,aes(x=Year,y=esc.log,color=Enhancement_Rank,group=SYS_NM))+
 geom_line()+
  theme_bw()+
  labs(y="log(Escapement)",title="Logged Escapement")

p3<-ggplot(escdata.filt,aes(x=Year,y=z,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  geom_hline(yintercept=0)+
  theme_bw()+
  labs(y="Z-scores (Escapement)",title="Z-scores Escapement")

p4<-ggplot(escdata.filt,aes(x=Year,y=esc.stand,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Standardized Escapement (pavg)",title="Escapement/Average (Pavg)")

ggarrange(p1,p2,p3,p4,ncol=1,common.legend = TRUE,align='v',legend="bottom")

```

\newpage

### Moving average and LOESSS fits

```{r moving average and LOESS plots, echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=5,fig.width=6,fig.cap="Moving average and LOESS fits on logged escapement by enhancement ranking."}

t1<-ggplot(escdata.filt,aes(x=Year,y=m.ave,color=Enhancement_Rank,group=SYS_NM))+
  geom_line()+
  theme_bw()+
  labs(y="Moving Average",title="Moving-Average",color="Enhancement Rank")

t2<-ggplot(escdata.filt,aes(x=Year,y=z,color=Enhancement_Rank,group=SYS_NM))+
  geom_smooth(method="loess",se=FALSE,span=.1,linewidth=.7)+
  geom_hline(yintercept=0)+
  theme_bw()+
  labs(y="Z-score",title="Loess fit on Z-scores")

ggarrange(t1,t2,ncol=1,common.legend = TRUE,legend = "bottom",align='v')

```

\newpage

### Means trends by enhancement rank

```{r means by enhancement rank, echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=7,fig.width=6,fig.cap="Area 25 chum: Mean Z-score for analysis streams by enhancement rank. Linear regression over all years with SE are shown."}

mean.z<-escdata.filt%>%group_by(Enhancement_Rank,Year) %>% summarise(u=mean(z,na.rm=TRUE))

ggplot(mean.z,aes(x=Year,y=u,color=Enhancement_Rank))+
  geom_line(size=1.5,alpha=.7)+theme_bw()+
  scale_color_brewer(palette = "Set1")+
  labs(y="Mean Z-score")+
  geom_hline(yintercept=0,linetype="dashed")+
  geom_vline(xintercept=1980)+
  facet_wrap(~Enhancement_Rank,ncol=1)+
  geom_smooth(method="lm",color="black")+
  guides(color=FALSE)
  
```

\newpage

### Recruits per spawner by system

```{r, Plotting RPS by system, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 7, fig.cap = "Area 25 chum: recruits per spawner by system."}

# RPS by system

ggplot(rps.clean,aes(x=Year,y=rps))+
  geom_line()+geom_point()+
  geom_smooth(method='lm',se=TRUE,size=.7)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_hline(yintercept=1)

```

\newpage

### Log recruits per spawner by system by period

```{r rps figure pre post with lm, echo=FALSE, warning=FALSE, message=FALSE ,fig.align="center", fig.height=7, fig.width=6 ,fig.cap="Area 25 chum: log recruits per spawner by system fitted with linear regression for the periods pre- and post-enhancement."}

a25.rps<-fread("data/area 25 chum rps.csv")

gga25.logrps<-a25.rps%>%select(Year,prepost,logrps,SYS_NM)%>%arrange(SYS_NM,prepost,Year)

idx <- c(1, diff(gga25.logrps$Year))
i2 <- c(1,which(idx != 1), nrow(gga25.logrps)+1)
gga25.logrps$grp <- rep(1:length(diff(i2)), diff(i2))

ggplot(gga25.logrps,aes(x=Year,y=logrps,color=prepost,group=grp))+
  geom_line(alpha=.5)+geom_point(alpha=.5)+
  scale_color_brewer(palette="Set1")+
  geom_smooth(method='lm',se=TRUE)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_hline(yintercept=0,linetype="dashed")+
  labs(x="Brood Year",y="log(Recruits per spawner)",color="Period")+
  theme(legend.position="bottom")
```


\newpage

### Log RPS comparison before and after enhancement

```{r rps figure boxplot,echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=7,fig.width=6,fig.cap="Area 25 chum: Boxplots of log recruits per spawner by system."}

ggplot(gga25.logrps,aes(y=SYS_NM,x=logrps,fill=prepost))+
  geom_boxplot(notch=F)+
  scale_fill_brewer(palette="Set1")+
  geom_vline(xintercept=0)+
  theme_bw()+
  labs(y="System Name",x="log(Recruits per spawner)",title="Area 25 Chum")+
  theme(legend.position="bottom")

```

\newpage

### Bubbleplots of metric by inlet

```{r, Malick and Cox plot z-score, message = FALSE, warning = FALSE, echo = FALSE, fig.align = "center", fig.height = 8, fig.width = 7, fig.cap = "Z-scores of log escapement for each system grouped by inlet. Solid blue points indicate positive values and open red circles indicate negative values. The size of the point indicates the magnitude of the metric."}

inlets <- read_csv("data/CM A25 filtered stream list_with inlets.csv")  %>%
  select(SYS_NM, inlet)

f<-escdata.filt%>%select(Year,SYS_NM,z)

g<-merge(f,inlets,by="SYS_NM")


`Z-score` <- c(-3, -2, -1, 0, 1, 2, 3)
shape <- c(21, 21, 21, 20, 19, 19, 19)
cols <- c("red", "red", "red", "black", "blue", "blue", "blue")
shapelkp <- tibble(`Z-score`, shape, cols)
g$`Z-score` <- as.numeric(substr(g$z, 1, 2))
g$size <- abs(g$z)
g <- merge(shapelkp, g, by = "Z-score")
g$`Z-score` <- as.factor(g$`Z-score`)

ggplot(g, aes(x = Year, y = SYS_NM, shape = `Z-score`, size = `Z-score`, color = `Z-score`, fill = `Z-score`)) +
  geom_point() +
  scale_size_manual(values = c("-3" = 5, "-2" = 3, "-1" = 2, 
                               "0" = 2, 
                               "1" = 2, "2" = 3, "3" = 5))+
  scale_shape_manual(values = c("-3" = 1, "-2" = 1, "-1" = 1, 
                                "0" = 20, 
                                "1" = 21, "2" = 21, "3" = 21)) +
  scale_color_manual(values = c("-3" = "darkred", "-2" = "red4", "-1" = "red1", 
                                "0" = "black", 
                                "1" = "royalblue1", "2" = "royalblue4", "3" = "royalblue4"))+
  scale_fill_manual(values = c("-3" = "darkred", "-2" = "red4", "-1" = "red1", 
                                "0" = "black", 
                                "1" = "royalblue1", "2" = "royalblue4", "3" = "royalblue4"))+
  labs(y="",x="Year", legend = "Z-score")+
  theme_bw()+
  theme(legend.position="bottom")+
  guides(size=FALSE)+
  theme(axis.text.y = element_text(size = 6))+
  guides(shape = guide_legend(ncol = 7))+ 
  facet_grid(inlet~.,switch="y",space="free_y",scale="free_y")

ggsave("figures/a25 z scores bubble by inlet.png",dpi=600,height=7,width=6)

```

\newpage

```{r, Malick and Cox plot logRPS, message = FALSE, warning = FALSE, echo = FALSE, fig.align = "center", fig.height = 8, fig.width = 7, fig.cap = "Log(recruits per spawner) for each system grouped by inlet. Solid blue points indicate positive values and open red circles indicate negative values. The size of the point indicates the magnitude of the metric."}
inlets <- read_csv("data/CM A25 filtered stream list_with inlets.csv")  %>%
  select(SYS_NM, inlet)

f<-rps.clean%>%select(Year,SYS_NM,logrps)

g<-merge(f,inlets,by="SYS_NM")


`log RPS` <- c(-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5)
shape <- c(21, 21, 21, 21, 21, 20, 19, 19, 19, 19, 19)
cols <- c("red", "red", "red", "red", "red", "black", "blue", "blue", "blue", "blue", "blue")
shapelkp <- tibble(`log RPS`, shape, cols)
g$`log RPS` <- as.numeric(substr(g$logrps, 1, 2))
g$size <- abs(g$`log RPS`)
g <- merge(shapelkp, g, by = "log RPS")
g$`log RPS` <- as.factor(g$`log RPS`)

ggplot(g, aes(x = Year, y = SYS_NM, shape = `log RPS`, size = `log RPS`, color = `log RPS`, fill = `log RPS`)) +
  geom_point() +
  scale_size_manual(values = c("-5" = 5, "-4" = 4, "-3" = 3, "-2" = 2, "-1" = 1, 
                               "0" = 1, 
                               "1" = 1, "2" = 2, "3" = 3, "4" = 4, "5" = 5))+
  scale_shape_manual(values = c("-5" = 1, "-4" = 1, "-3" = 1, "-2" = 1, "-1" = 1, 
                                "0" = 20, 
                                "1" = 21, "2" = 21, "3" = 21, "4" = 21, "5" = 21)) +
  scale_color_manual(values = c("-5" = "darkred", "-4" = "darkred","-3" = "darkred",
                                "-2" = "red4", "-1" = "red1", 
                                "0" = "black", 
                                "1" = "royalblue1", "2" = "royalblue2", "3" = "royalblue3",
                                "4" = "royalblue4", "5" = "royalblue4"))+
  scale_fill_manual(values = c("-5" = "darkred", "-4" = "darkred",
                               "-3" = "darkred", "-2" = "red4", "-1" = "red1", 
                                "0" = "black", 
                                "1" = "royalblue1", "2" = "royalblue4", "3" = "royalblue4",
                                "4" = "royalblue4", "5" = "royalblue4"))+
  labs(y="",x="Year")+
  theme_bw()+
  theme(legend.position="bottom")+
  guides(size=FALSE)+
  theme(axis.text.y = element_text(size = 6))+
  guides(shape = guide_legend(ncol = 11, nrow = 2))+ 
  facet_grid(inlet~.,switch="y",space="free_y",scale="free_y")

ggsave("figures/a25 log RPS bubble by inlet.png",dpi=600,height=7,width=6)

```


\newpage

```{r correlations for all metrics, echo = FALSE, warning = FALSE, message = FALSE}

#prep data for correlations

# Merge stream inlet table into escdata.filt

streaminlet <- fread("data/CM A25 filtered stream list_with inlets.csv")

rps.clean <- merge(streaminlet, rps.clean, by = "SYS_NM", all = TRUE)

escdata.filt<-merge(escdata.filt,streaminlet,by="SYS_NM")

#old way
#escdata.filt <- escdata.filt %>%
#  inner_join(streaminlet, escdata.filt, by = "SYS_NM")

# Factor out inlet and create escdata.filt of inlet colours

escdata.filt$inlet <- as.factor(escdata.filt$inlet)
inlets <- as.data.frame(levels(escdata.filt$inlet))
inlets$colour <- c("red", "blue", "darkgreen")
colnames(inlets) <- c("inlet", "colour")


# Correlation analysis by z-score

cor.data.z<-escdata.filt%>%select(SYS_NM,Year,z)%>%
  pivot_wider(names_from="Year",values_from="z")%>%
  data.frame()

rownames(cor.data.z)<-cor.data.z$SYS_NM

cor.data.z<-cor.data.z%>%select(-SYS_NM)

cor.z<-cor(t(cor.data.z),use="pairwise.complete.obs")

# Dendrogram, factored by inlet, by z-score

dist.cor.z<- dist(cor.z)
clust.dist.cor.z <- hclust(dist.cor.z)

dendclust.z <- dendro_data(clust.dist.cor.z)
zlabs <- as.data.frame(dendclust.z[["labels"]][["label"]])

zlabs$order <- 1:length(zlabs[,1])
colnames(zlabs) <- c("SYS_NM", "order")
zlabs <- merge(streaminlet, zlabs, by = "SYS_NM")
zlabs <- merge(inlets, zlabs, by = "inlet")
zlabs <- zlabs %>%
  arrange(order)
zlabcolours <- zlabs$colour
zlabnames <- zlabs$SYS_NM
inletlist <- as.factor(zlabs$inlet) 
  
dendclust.z[["labels"]][["inlet"]] <- inletlist

nameslookup <- as.data.frame(c("Tlupana", "Canton", "Conuma", "Leiner", "Deserted", "Sucwoa", 
                 "Mooyah", "Ransom", "Burman", "Kleeptee", "Espinosa",
                 "L. Zeballos", "Hoiss", "Lord", "Zeballos", "Tahsis", "Tsowwin",
                 "Hammond", "Marvinas", "Brodick", "Owossitsa", "Chum", 
                 "Mamat", "Park"))

colnames(nameslookup) <- "shortnames"

nameslookup$SYS_NM <- zlabnames  

nameslookup$erank <- c("red", "red", "red", "black", "#3399FF", "red",
                       "black", "black", "black", "black", "black",
                       "black", "black", "black", "red", "black", "black",
                       "black", "black", "black", "black", "black",
                       "black", "black")
  
dendclust.z[["labels"]][["inlet"]] <- inletlist

xlenz <- .95 * length(zlabs$SYS_NM)
ylenz <- .95 * (max(dendclust.z[["segments"]][["y"]]))

# Correlation analysis by log escapement

cor.data.e<-escdata.filt%>%select(SYS_NM,Year,esc.log)%>%pivot_wider(names_from="Year",values_from="esc.log")%>%data.frame()

rownames(cor.data.e)<-cor.data.e$SYS_NM

cor.data.e<-cor.data.e%>%select(-SYS_NM)

cor.e<-cor(t(cor.data.e),use="pairwise.complete.obs")

# Dendrogram, factored by inlet, by log escapement

dist.cor.e<- dist(cor.e)
clust.dist.cor.e <- hclust(dist.cor.e)

dendclust.e <- dendro_data(clust.dist.cor.e)
elabs <- as.data.frame(dendclust.e[["labels"]][["label"]])
elabs$order <- 1:length(elabs[,1])
colnames(elabs) <- c("SYS_NM", "order")
elabs <- merge(streaminlet, elabs, by = "SYS_NM")
elabs <- merge(inlets, elabs, by = "inlet")
elabs <- elabs %>%
  arrange(order)
elabcolours <- elabs$colour
elabnames <- elabs$SYS_NM
inletlist <- as.factor(elabs$inlet)
  
dendclust.e[["labels"]][["inlet"]] <- inletlist

xlene <- .95 * length(elabs$SYS_NM)
ylene <- .95 * (max(dendclust.e[["segments"]][["y"]]))


# Correlation analysis by standardized escapement
cor.data.s<-escdata.filt%>%select(SYS_NM,Year,esc.stand)%>%pivot_wider(names_from="Year",values_from="esc.stand")%>%data.frame()

rownames(cor.data.s)<-cor.data.s$SYS_NM

cor.data.s<-cor.data.s%>%select(-SYS_NM)

cor.s<-cor(t(cor.data.s),use="pairwise.complete.obs")

# Dendrogram, factored by inlet, by standardized escapement

dist.cor.s<- dist(cor.s)
clust.dist.cor.s <- hclust(dist.cor.s)

dendclust.s <- dendro_data(clust.dist.cor.s)
slabs <- as.data.frame(dendclust.s[["labels"]][["label"]])
slabs$order <- 1:length(slabs[,1])
colnames(slabs) <- c("SYS_NM", "order")
slabs <- merge(streaminlet, slabs, by = "SYS_NM")
slabs <- merge(inlets, slabs, by = "inlet")
slabs <- slabs %>%
  arrange(order)
slabcolours <- slabs$colour
slabnames <- slabs$SYS_NM
inletlist <- as.factor(slabs$inlet)
  
dendclust.s[["labels"]][["inlet"]] <- inletlist

xlens <- .95 * length(slabs$SYS_NM)
ylens <- .95 * (max(dendclust.s[["segments"]][["y"]]))

# Correlation analysis by moving average
cor.data.m<-escdata.filt%>%select(SYS_NM,Year,m.ave)%>%pivot_wider(names_from="Year",values_from="m.ave")%>%data.frame()

rownames(cor.data.m)<-cor.data.m$SYS_NM

cor.data.m<-cor.data.m%>%select(-SYS_NM)

cor.m<-cor(t(cor.data.m),use="pairwise.complete.obs")

# Dendrogram, factored by inlet, by moving average

dist.cor.m<- dist(cor.m)
clust.dist.cor.m <- hclust(dist.cor.m)
dendclust.m <- dendro_data(clust.dist.cor.m)

mlabs <- as.data.frame(dendclust.m[["labels"]][["label"]])
mlabs$order <- 1:length(mlabs[,1])
colnames(mlabs) <- c("SYS_NM", "order")
mlabs <- merge(streaminlet, mlabs, by = "SYS_NM")
mlabs <- merge(inlets, mlabs, by = "inlet")
mlabs <- mlabs %>%
  arrange(order)
mlabcolours <- mlabs$colour
mlabnames <- mlabs$SYS_NM
inletlist <- as.factor(mlabs$inlet)
  
dendclust.m[["labels"]][["inlet"]] <- inletlist

xlenm <- .95 * length(mlabs$SYS_NM)
ylenm <- .95 * (max(dendclust.m[["segments"]][["y"]]))

cor.data.rps<-rps.clean%>%select(SYS_NM,Year,rps)%>%
  pivot_wider(names_from="Year",values_from="rps")%>%
  data.frame()
rownames(cor.data.rps)<-cor.data.rps$SYS_NM
cor.data.rps<-cor.data.rps%>%select(-SYS_NM)
cor.rps<-cor(t(cor.data.rps),use="pairwise.complete.obs")
dist.cor.rps<- dist(cor.rps)
clust.dist.cor.rps <- hclust(dist.cor.rps)
dendclust.rps <- dendro_data(clust.dist.cor.rps)

cor.data.rpslog<-rps.clean%>%select(SYS_NM,Year,logrps)%>%
  pivot_wider(names_from="Year",values_from="logrps")%>%
  data.frame()
rownames(cor.data.rpslog)<-cor.data.rpslog$SYS_NM
cor.data.rpslog<-cor.data.rpslog%>%select(-SYS_NM)
cor.rpslog<-cor(t(cor.data.rpslog),use="pairwise.complete.obs")
dist.cor.rpslog<- dist(cor.rpslog)
clust.dist.cor.rpslog <- hclust(dist.cor.rpslog)
dendclust.rpslog <- dendro_data(clust.dist.cor.rpslog)


```

\newpage

# Correlation analyses and Dendrograms

## Cross correlation plots

```{r correlation plots, echo=FALSE,warning=FALSE,message=FALSE,fig.align="center",fig.height=9.5,fig.width=8.5,fig.cap="Cross correlation plots to compare metrics."}

# Corplots to knit

#png(file = "figures/corrplots.png", width = 2000, height = 3000, pointsize = 48)

par(oma=c(0,0,0,0))
par(mfrow=c(3,2))

corrplot(cor.z, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Z-scores", mar=c(0,0,3,0))
corrplot(cor.e, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Log escapement", mar=c(0,0,3,0))
corrplot(cor.s, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Standardized escapement", mar=c(0,0,3,0))
corrplot(cor.m, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Moving average", mar=c(0,0,3,0))
corrplot(cor.rps, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "RPS", mar=c(0,0,3,0))
corrplot(cor.rpslog, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.45, title = "Log RPS", mar=c(0,0,3,0))

#dev.off()
```

\newpage
```{r Pairwise plots, Pairwise distance matrix stuff, echo = FALSE, message = FALSE, warning = FALSE}
 
par(mfrow=c(1,1))
# NEW code re: pairwise distance matrix from Ben Skinner
long.z <- as.data.frame(cor.z) %>%  
  rownames_to_column('row') %>% 
  pivot_longer(cols = -row)

names(long.z) <- c("source_stream", "destination_stream", "zscore")

dist_corr <- merge(pairwise, long.z, by = "source_stream")
dist_corr <- dist_corr[dist_corr$destination_stream.x == dist_corr$destination_stream.y,]
dist_corr <- dist_corr[,c(1, 2, 3, 6)]
names(dist_corr) <- c("source_stream", "destination_stream", "distance", "zscore")
dist_corr$plotlabels <- paste0(dist_corr$source_stream, "-", dist_corr$destination_stream)


#png(file = "figures/pairwise_correlations.png", width = 1024, height = 768, pointsize = 48)
ggplot(dist_corr, aes(distance/1000, zscore)) +
  geom_point() +
  labs(x = "Pairwise distance (km)", y = "Pairwise correlation (z-score)")
#dev.off()

# Pivot pairwise distance matrix wide for use in dendrograms

pairwise <- pairwise %>%
  filter(source_stream != "INNER BASIN RIVER") %>%
  filter(destination_stream != "INNER BASIN RIVER")

pairwide <- pairwise[,1:3] %>%
  pivot_wider(names_from = c("source_stream"),
              values_from = "distance_m")

pairwide[is.na(pairwide)] <- 0
pairwide <- as.data.frame(pairwide)
rownames(pairwide) <- pairwide[,1]
pairwide <- pairwide[,-1]
pairwide <- mutate_all(pairwide, function(x) as.numeric(as.character(x)))
cor.d <- cor(t(pairwide), use = "pairwise.complete.obs")
dist.cor.d<- dist(cor.d)
clust.dist.cor.d <- hclust(dist.cor.d)
dendclust.d <- dendro_data(clust.dist.cor.d)

dlabs <- as.data.frame(dendclust.d[["labels"]][["label"]])
colnames(dlabs) <- "SYS_NM"
dlabs$order <- c(1:length(dlabs$SYS_NM))
dlabs <- merge(dlabs, rps.clean, by = "SYS_NM")
dlabs <- dlabs %>%
  select(SYS_NM, order, inlet)
dlabs <- distinct(dlabs)
dlabcols <- as.data.frame(unique(dlabs$inlet))
colnames(dlabcols) <- "inlet"
dlabcols <- dlabcols %>%
  arrange(inlet)
dlabcols$colour <- c("red", "blue", "forestgreen")
dlabs <- merge(dlabcols, dlabs, by = "inlet")
dlabs <- dlabs %>%
  arrange(order)
dlabs <- dlabs$colour

clust.dist.cor.d[["labels"]] <- str_to_title(clust.dist.cor.d[["labels"]])

dendd <- as.dendrogram(clust.dist.cor.d)

#png(file = "figures/distances_dendrogram.png", width = 800, height = 600, pointsize = 12)
dendd %>%
    set("labels_colors", dlabs) %>%
    plot(main = "Dendrogram of distance clusters", horiz = TRUE, dLeaf = 0.05)
#dev.off()


```

\newpage

```{r, Make colour vectors for dendrogram inlets, message=FALSE, warning=FALSE, echo=FALSE, include = FALSE}

zlabs <- as.data.frame(dendclust.z[["labels"]][["label"]])
colnames(zlabs) <- "SYS_NM"
zlabs$order <- c(1:length(zlabs$SYS_NM))
zlabs <- merge(zlabs, rps.clean, by = "SYS_NM")
zlabs <- zlabs %>%
  select(SYS_NM, order, inlet)
zlabs <- distinct(zlabs)
zlabcols <- as.data.frame(unique(zlabs$inlet))
colnames(zlabcols) <- "inlet"
zlabcols <- zlabcols %>%
  arrange(inlet)
zlabcols$colour <- c("red", "blue", "green")
zlabs <- merge(zlabcols, zlabs, by = "inlet")
zlabs <- zlabs %>%
  arrange(order)
zlabs <- zlabs$colour

elabs <- as.data.frame(dendclust.e[["labels"]][["label"]])
colnames(elabs) <- "SYS_NM"
elabs$order <- c(1:length(elabs$SYS_NM))
elabs <- merge(elabs, rps.clean, by = "SYS_NM")
elabs <- elabs %>%
  select(SYS_NM, order, inlet)
elabs <- distinct(elabs)
elabcols <- as.data.frame(unique(elabs$inlet))
colnames(elabcols) <- "inlet"
elabcols <- elabcols %>%
  arrange(inlet)
elabcols$colour <- c("red", "blue", "green")
elabs <- merge(elabcols, elabs, by = "inlet")
elabs <- elabs %>%
  arrange(order)
elabs <- elabs$colour

slabs <- as.data.frame(dendclust.s[["labels"]][["label"]])
colnames(slabs) <- "SYS_NM"
slabs$order <- c(1:length(slabs$SYS_NM))
slabs <- merge(slabs, rps.clean, by = "SYS_NM")
slabs <- slabs %>%
  select(SYS_NM, order, inlet)
slabs <- distinct(slabs)
slabcols <- as.data.frame(unique(slabs$inlet))
colnames(slabcols) <- "inlet"
slabcols <- slabcols %>%
  arrange(inlet)
slabcols$colour <- c("red", "blue", "green")
slabs <- merge(slabcols, slabs, by = "inlet")
slabs <- slabs %>%
  arrange(order)
slabs <- slabs$colour

mlabs <- as.data.frame(dendclust.m[["labels"]][["label"]])
colnames(mlabs) <- "SYS_NM"
mlabs$order <- c(1:length(mlabs$SYS_NM))
mlabs <- merge(mlabs, rps.clean, by = "SYS_NM")
mlabs <- mlabs %>%
  select(SYS_NM, order, inlet)
mlabs <- distinct(mlabs)
mlabcols <- as.data.frame(unique(mlabs$inlet))
colnames(mlabcols) <- "inlet"
mlabcols <- mlabcols %>%
  arrange(inlet)
mlabcols$colour <- c("red", "blue", "green")
mlabs <- merge(mlabcols, mlabs, by = "inlet")
mlabs <- mlabs %>%
  arrange(order)
mlabs <- mlabs$colour

rpslabs <- as.data.frame(dendclust.rps[["labels"]][["label"]])
colnames(rpslabs) <- "SYS_NM"
rpslabs$order <- c(1:length(rpslabs$SYS_NM))
rpslabs <- merge(rpslabs, rps.clean, by = "SYS_NM")
rpslabs <- rpslabs %>%
  select(SYS_NM, order, inlet)
rpslabs <- distinct(rpslabs)
rpslabcols <- as.data.frame(unique(rpslabs$inlet))
colnames(rpslabcols) <- "inlet"
rpslabcols <- rpslabcols %>%
  arrange(inlet)
rpslabcols$colour <- c("red", "blue", "green")
rpslabs <- merge(rpslabcols, rpslabs, by = "inlet")
rpslabs <- rpslabs %>%
  arrange(order)
rpslabs <- rpslabs$colour


rpsloglabs <- as.data.frame(dendclust.rpslog[["labels"]][["label"]])
colnames(rpsloglabs) <- "SYS_NM"
rpsloglabs$order <- c(1:length(rpsloglabs$SYS_NM))
rpsloglabs <- merge(rpsloglabs, rps.clean, by = "SYS_NM")
rpsloglabs <- rpsloglabs %>%
  select(SYS_NM, order, inlet)
rpsloglabs <- distinct(rpsloglabs)
rpsloglabcols <- as.data.frame(unique(rpsloglabs$inlet))
colnames(rpsloglabcols) <- "inlet"
rpsloglabcols <- rpsloglabcols %>%
  arrange(inlet)
rpsloglabcols$colour <- c("red", "blue", "green")
rpsloglabs <- merge(rpsloglabcols, rpsloglabs, by = "inlet")
rpsloglabs <- rpsloglabs %>%
  arrange(order)
rpsloglabs <- rpsloglabs$colour

```

```{r, Dendrogram plots, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Dendrograms by metric. Red labels are from Esperanza inlet, blue are from Nootka inlet, and green are from Tahsis inlet."}

par(oma=c(0,0,0,0))
par(mfrow=c(3,2))

clust.dist.cor.z[["labels"]] <- str_to_sentence(word(clust.dist.cor.z[["labels"]]))
dendz <- as.dendrogram(clust.dist.cor.z)
dendz %>%
    set("labels_colors", zlabs) %>%
    plot(main = "Z-scores", horiz = TRUE)

clust.dist.cor.e[["labels"]] <- str_to_sentence(word(clust.dist.cor.e[["labels"]]))
dende <- as.dendrogram(clust.dist.cor.e)
dende %>%
    set("labels_colors", elabs) %>%
    plot(main = "Log escapement", horiz = TRUE)

clust.dist.cor.s[["labels"]] <- str_to_sentence(word(clust.dist.cor.s[["labels"]]))
dends <- as.dendrogram(clust.dist.cor.s)
dends %>%
    set("labels_colors", slabs) %>%
    plot(main = "Standardized escapement", horiz = TRUE)

clust.dist.cor.m[["labels"]] <- str_to_sentence(word(clust.dist.cor.m[["labels"]]))
dendm <- as.dendrogram(clust.dist.cor.m)
dendm %>%
    set("labels_colors", mlabs) %>%
    plot(main = "Moving average", horiz = TRUE)

clust.dist.cor.rps[["labels"]] <- str_to_sentence(word(clust.dist.cor.rps[["labels"]]))
dendrps <- as.dendrogram(clust.dist.cor.rps)
dendrps %>%
    set("labels_colors", rpslabs) %>%
    plot(main = "RPS", horiz = TRUE)

clust.dist.cor.rpslog[["labels"]] <- str_to_sentence(word(clust.dist.cor.rpslog[["labels"]]))
dendrpslog <- as.dendrogram(clust.dist.cor.rpslog)
dendrpslog %>%
    set("labels_colors", rpsloglabs) %>%
    plot(main = "Log RPS", horiz = TRUE)
```

\newpage

## Tanglegrams comparing effect of metric choice on cluster analysis

```{r tanglegram z vs log, echo = FALSE, warning = FALSE, message = FALSE,  fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Tanglegram comparing the use of z-score against the use of log escapements on cluster analysis outputs."}

#png(file = "figures/tanglegram_z_v_log.png", width = 2000, height = 3000, pointsize = 36)

par(oma=c(2,2,2,2))
par(mfrow=c(1,1))

tangle1 <- dendlist(dendz, dende)
tanglegram(tangle1, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Log escapement", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```

\newpage
```{r tanglegram a vs m.ave, echo = FALSE, warning = FALSE, message = FALSE,  fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Tanglegram comparing the use of z-score against the use of moving average on cluster analysis outputs."}

#png(file = "figures/tanglegram_z_v_mave.png", width = 2000, height = 3000, pointsize = 36)

tangle3 <- dendlist(dendz, dendm)
tanglegram(tangle3, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Moving average", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)
#dev.off()

```

\newpage

```{r, Tanglegrams z vs logRPS, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 9.5, fig.width = 8.5, fig.cap = "Tanglegram of z-score vs. Log RPS"}

#png(file = "figures/a06cm_tanglegram_z_v_mave.png", width = 2000, height = 3000, pointsize = 36)

tangle4 <- dendlist(dendz, dendrpslog)
                                                                                                            
tanglegram(tangle4, lab.cex = .8, margin_inner = 3, main_left = "Z-score",
           main_right = "Log RPS", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```

\newpage

# Pre- and post-enhancement correlation analyses

```{r Corr plots for z-score, pre- and post-1980, echo=FALSE, warning=FALSE, message=FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Cross correlation plots of z-scores to compare pre- and post-enhancement."}
#prep data for correlations

cor.data.z <-escdata.filt %>%
  select(SYS_NM,Year,z) %>%
  pivot_wider(names_from="Year",values_from="z") %>%
  data.frame()

cor.data.z.pre<-cor.data.z[,1:31]
rownames(cor.data.z.pre)<-cor.data.z.pre$SYS_NM
cor.data.z.pre<-cor.data.z.pre%>%select(-SYS_NM)
cor.z.pre<-cor(t(cor.data.z.pre),use="pairwise.complete.obs")

cor.data.z.post<-cor.data.z[,c(1,32:70)]
rownames(cor.data.z.post)<-cor.data.z.post$SYS_NM
cor.data.z.post<-cor.data.z.post%>%select(-SYS_NM)
cor.z.post<-cor(t(cor.data.z.post),use="pairwise.complete.obs")

#png(file = "figures/corrplot_1980_z.png", width = 2000, height = 3000, pointsize = 48)

par(mfrow=c(2,1))
corrplot(cor.z.pre, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.5, title = "Z-scores (Pre-1980)", cex.main = .7, mar=c(0,0,1,0))
corrplot(cor.z.post, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.5, title = "Z-score (Post-1980)", sub = "Z-scores", cex.main = .7, mar=c(0,0,1,0))

#dev.off()
```

\newpage

```{r, z-score tanglegram, echo = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Tanglegram comparing z-scores pre- and post-enhancement (1980)"}
# Dendrogram, factored by inlet, by z-score

#png(file = "figures/tanglegram_1980_z.png", width = 2000, height = 3000, pointsize = 48)

par(mfrow=c(1,1))

# Pre-1980
dist.cor.z.pre <- dist(cor.z.pre)
clust.dist.cor.z.pre <- hclust(dist.cor.z.pre)
tanglelabs.z.pre <- as.data.frame(clust.dist.cor.z.pre[["labels"]])
colnames(tanglelabs.z.pre) <- "SYS_NM"
tanglelabs.z.pre <- merge(tanglelabs.z.pre, nameslookup, on = "SYS_NM")
clust.dist.cor.z.pre[["labels"]] <- tanglelabs.z.pre$shortnames
dendz.pre <- as.dendrogram(clust.dist.cor.z.pre)

# Post-1980
dist.cor.z.post <- dist(cor.z.post)
clust.dist.cor.z.post <- hclust(dist.cor.z.post)
tanglelabs.z.post <- as.data.frame(clust.dist.cor.z.post[["labels"]])
colnames(tanglelabs.z.post) <- "SYS_NM"
tanglelabs.z.post <- merge(tanglelabs.z.post, nameslookup, on = "SYS_NM")
clust.dist.cor.z.post[["labels"]] <- tanglelabs.z.post$shortnames
dendz.post <- as.dendrogram(clust.dist.cor.z.post)

# Tanglegram
tangle.z <- dendlist(dendz.pre, dendz.post)
tanglegram(tangle.z, lab.cex = .8, margin_inner = 3, main = "Z-scores", main_left = "Pre-1980",
           main_right = "Post-1980", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```

\newpage

```{r, Pre-1980 logrps, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Cross correlation plots of Log RPS to compare pre- and post-enhancement."}

cor.data.logrps <-rps.clean %>%
  select(SYS_NM,Year,logrps) %>%
  pivot_wider(names_from="Year",values_from="logrps") %>%
  data.frame()

cor.data.logrps.pre<-cor.data.logrps[,1:27]
rownames(cor.data.logrps.pre)<-cor.data.logrps.pre$SYS_NM
cor.data.logrps.pre<-cor.data.logrps.pre%>%select(-SYS_NM)
cor.logrps.pre<-cor(t(cor.data.logrps.pre),use="pairwise.complete.obs")

cor.data.logrps.post<-cor.data.logrps[,c(1,28:63)]
rownames(cor.data.logrps.post)<-cor.data.logrps.post$SYS_NM
cor.data.logrps.post<-cor.data.logrps.post%>%select(-SYS_NM)
cor.logrps.post<-cor(t(cor.data.logrps.post),use="pairwise.complete.obs")

dist.cor.logrps.pre <- dist(cor.logrps.pre)
clust.dist.cor.logrps.pre <- hclust(dist.cor.logrps.pre)
tanglelabs.logrps.pre <- as.data.frame(clust.dist.cor.logrps.pre[["labels"]])
colnames(tanglelabs.logrps.pre) <- "SYS_NM"
tanglelabs.logrps.pre$shortnames <- str_to_sentence(word(tanglelabs.logrps.pre$SYS_NM))
#colnames(nameslookup) <- "SYS_NM"
clust.dist.cor.logrps.pre[["labels"]] <- tanglelabs.logrps.pre$shortnames
dendlogrps.pre <- as.dendrogram(clust.dist.cor.logrps.pre)

# Post-1980
cor.data.logrps.post<-cor.data.logrps[,1:26]
rownames(cor.data.logrps.post)<-cor.data.logrps.post$SYS_NM
cor.data.logrps.post<-cor.data.logrps.post%>%select(-SYS_NM)
cor.logrps.post<-cor(t(cor.data.logrps.post),use="pairwise.complete.obs")

cor.data.logrps.post<-cor.data.logrps[,c(1,27:62)]
rownames(cor.data.logrps.post)<-cor.data.logrps.post$SYS_NM
cor.data.logrps.post<-cor.data.logrps.post%>%select(-SYS_NM)
cor.logrps.post<-cor(t(cor.data.logrps.post),use="pairwise.complete.obs")

dist.cor.logrps.post <- dist(cor.logrps.post)
clust.dist.cor.logrps.post <- hclust(dist.cor.logrps.post)
tanglelabs.logrps.post <- as.data.frame(clust.dist.cor.logrps.post[["labels"]])
colnames(tanglelabs.logrps.post) <- "SYS_NM"
tanglelabs.logrps.post$shortnames <- str_to_sentence(word(tanglelabs.logrps.post$SYS_NM))
#colnames(nameslookup) <- "SYS_NM"
clust.dist.cor.logrps.post[["labels"]] <- tanglelabs.logrps.post$shortnames
dendlogrps.post <- as.dendrogram(clust.dist.cor.logrps.post)

par(mfrow=c(2,1))
corrplot(cor.logrps.pre, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.5, title = "Log RPS (Pre-1980)", cex.main = .7, mar=c(0,0,1,0))
corrplot(cor.logrps.post, diag = FALSE, order="hclust", method="square", tl.col="black",
         addrect = 6, tl.cex = 0.5, title = "Lof RPS (Post-1980)", cex.main = .7, mar=c(0,0,1,0))


```

\newpage

```{r, Log RPS tanglegram, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 6, fig.cap = "Tanglegram comparing Log RPS pre- and post-enhancement (1980)"}
# Dendrogram, factored by inlet, by logrps-score

#png(file = "figures/tanglegram_1980_logrps.png", width = 2000, height = 3000, pointsilogrpse = 48)

par(mfrow=c(1,1))

# Pre-1980
dist.cor.logrps.pre <- dist(cor.logrps.pre)
clust.dist.cor.logrps.pre <- hclust(dist.cor.logrps.pre)
tanglelabs.logrps.pre <- as.data.frame(clust.dist.cor.logrps.pre[["labels"]])
colnames(tanglelabs.logrps.pre) <- "SYS_NM"
#tanglelabs.logrps.pre <- merge(tanglelabs.logrps.pre, nameslookup, on = "SYS_NM")
tanglelabs.logrps.pre$shortnames <- str_to_sentence(word(tanglelabs.logrps.pre$SYS_NM))
clust.dist.cor.logrps.pre[["labels"]] <- tanglelabs.logrps.pre$shortnames
dendlogrps.pre <- as.dendrogram(clust.dist.cor.logrps.pre)

# Post-1980
dist.cor.logrps.post <- dist(cor.logrps.post)
clust.dist.cor.logrps.post <- hclust(dist.cor.logrps.post)
tanglelabs.logrps.post <- as.data.frame(clust.dist.cor.logrps.post[["labels"]])
colnames(tanglelabs.logrps.post) <- "SYS_NM"
#tanglelabs.logrps.post <- merge(tanglelabs.logrps.post, nameslookup, on = "SYS_NM")
tanglelabs.logrps.post$shortnames <- str_to_sentence(word(tanglelabs.logrps.post$SYS_NM))
clust.dist.cor.logrps.post[["labels"]] <- tanglelabs.logrps.post$shortnames
dendlogrps.post <- as.dendrogram(clust.dist.cor.logrps.post)

# Tanglegram
tangle.logrps <- dendlist(dendlogrps.pre, dendlogrps.post)
tanglegram(tangle.logrps, lab.cex = .8, margin_inner = 3, main = "Log RPS", main_left = "Pre-1980",
           main_right = "Post-1980", cex_main = 1, highlight_distinct_edges = FALSE,
           lwd = 2, edge.lwd = 1)

#dev.off()

```

```{r, compute boxplot zscores, message = FALSE, error = FALSE, echo = FALSE, include = FALSE}
pre<-data.frame(cor.z.pre)
pre$stream1<-rownames(pre)
post<-data.frame(cor.z.post)
post$stream1<-rownames(post)
pre<-pre%>%pivot_longer(1:ncol(pre)-1,names_to="stream2",values_to="cc")%>%
  mutate(cc=replace(cc,cc==1,NA),
         area="DG",period="Pre")
post<-post%>%pivot_longer(1:ncol(post)-1,names_to="stream2",values_to="cc")%>%
  mutate(cc=replace(cc,cc==1,NA),
         area="DG",period="Post")
dg.z<-rbind(pre,post)%>%mutate(metric="Z-score")
u.pre<-mean(pre$cc,na.rm=TRUE)
sd.pre<-sd(pre$cc,na.rm=TRUE)
u.post<-mean(post$cc,na.rm=TRUE)
sd.post<-sd(post$cc,na.rm=TRUE)
#u.pre;sd.pre
#u.post;sd.post
precc<-pre$cc
postcc<-post$cc
t.test(pre$cc,post$cc)
```

```{r, compute boxplot logrps, message = FALSE, error = FALSE, echo = FALSE, include = FALSE}
pre <- data.frame(cor.logrps.pre)
pre$stream1<-rownames(pre)
post<-data.frame(cor.logrps.post)
post$stream1<-rownames(post)
pre<-pre%>%pivot_longer(1:ncol(pre)-1,names_to="stream2",values_to="cc")%>%
  mutate(cc=replace(cc,cc==1,NA),
         area="DG",period="Pre")
post<-post%>%pivot_longer(1:ncol(post)-1,names_to="stream2",values_to="cc")%>%
  mutate(cc=replace(cc,cc==1,NA),
         area="DG",period="Post")
dg.rps<-rbind(pre,post)%>%mutate(metric="log(RPS)")
u.pre<-mean(pre$cc,na.rm=TRUE)
sd.pre<-sd(pre$cc,na.rm=TRUE)
u.post<-mean(post$cc,na.rm=TRUE)
sd.post<-sd(post$cc,na.rm=TRUE)
#u.pre;sd.pre
#u.post;sd.post
precc<-pre$cc
postcc<-post$cc
t.test(pre$cc,post$cc)
```


\newpage

```{r, message = FALSE, error = FALSE, warning = FALSE, echo = FALSE,fig.align = "center", fig.height = 5, fig.width = 6, fig.cap = "Comparison between correlation coefficients for all pairwise combinations of streams using Z-score and log(RPS) over the pre- and post-1980 periods."}

cc.all<-rbind(dg.z,dg.rps)

ggplot(cc.all,aes(x=factor(period,levels=c("Pre","Post")),y=cc,fill=period))+
  geom_boxplot()+
  scale_fill_brewer(palette="Set1",breaks=c("Pre","Post"))+
  xlab("Period")+theme_bw()+
  ylab("Correlation coefficient")+labs(fill="Period")+
  facet_grid(.~metric)

```

\newpage

# Statistical models

## Candidate Models with AIC scores for log RPS and log escapement

```{r, AIC Table for RPS candidate models, echo = FALSE, message = FALSE, warning = FALSE}

rpsaic <- readRDS("RDS/rpsaic.rds")
rpstab <- readRDS("RDS/rpstab.rds")

rpstab$`Degrees of freedom` <- rpsaic$df
rpstab$AIC <- rpsaic$AIC

rpstab <- rpstab %>%
  arrange(AIC)

kable(rpstab, format = "latex",caption="Candidate models for log RPS and distance from enhancement (dist), total releases (totrel), and year, with AIC scores.")%>%
 kable_styling(latex_options = "hold_position")


#rpstab %>%
#  kbl(align = colaligns) %>%
#  kable_paper(full_width = F, html_font = "Courier New") %>%
#  kable_styling(latex_options = "HOLD_position")

```

```{r, AIC Table for Escapement candidate models, echo = FALSE, message = FALSE, warning = FALSE}

escaic <- readRDS("RDS/escaic.rds")
esctab <- readRDS("RDS/esctab.rds")

esctab$`Degrees of freedom` <- escaic$df
esctab$AIC <- escaic$AIC 

esctab <- esctab %>%
  arrange(AIC)

kable(esctab, format = "latex",caption="Candidate models for log escapement and distance from enhancement (dist), total releases (totrel), and year, with AIC scores.")%>%
   kable_styling(latex_options = "hold_position")

#esctab %>%
#  kbl(align = colaligns) %>%
 # kable_paper(full_width = F, html_font = "Courier New") %>%
  #kable_styling(latex_options = "HOLD_position")

```


\newpage

## Effects plots for top models 

```{r, Effects plot log rps by year, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 5, fig.width = 8, fig.cap = "Effects plots of Recruits per spawner by year"}

par(mfrow=c(1,1))

EPC_RPS_YEAR <- readRDS("RDS/EPC_RPS_YEAR.rds")
plot(EPC_RPS_YEAR)

```

```{r, Effects plots log rps by totrel, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 5, fig.width = 8, fig.cap = "Effects plots of Recruits per spawner by total releases"}

par(mfrow=c(1,1))

EPC_RPS_TOTREL <- readRDS("RDS/EPC_RPS_TOTREL.rds")
plot(EPC_RPS_TOTREL)
```

```{r, Effects plots escapement x corcoef, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 5, fig.width = 8, fig.cap = "Effects plots of Escapement by correlation coefficient"}

EP_ESC_COR <- readRDS("RDS/EP_ESC_COR.rds")
plot(EP_ESC_COR)

```

```{r, Effects plots escapement x dist, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 5, fig.width = 8, fig.cap = "Effects plots of Escapement by distance from enhancement"}
EP_ESC_DIST <- readRDS("RDS/EP_ESC_DIST.rds")
plot(EP_ESC_DIST)
```

```{r, Effects plots escapement esc x totrel, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 5, fig.width = 8, fig.cap = "Effects plots of Escapement by correlation coefficient"}
EP_ESC_TOTREL <- readRDS("RDS/EP_ESC_TOTREL.rds")
plot(EP_ESC_TOTREL)
```
