---
title: "mixed_effects_model"
output: html_document
date: '2022-11-23'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(car) # Will mask select function in dplyr. Unload and restart to revert.
library(MASS)
library(tidyverse)
library(lme4)
library(plyr)
library(dplyr)

streaminlet <- read_csv("CM A25 filtered stream list_with inlets.csv")
rpsdat <- readRDS("RPS.rds")
totrel <- readRDS("totrel.rds")

```


```{r Identify distributions of predictor variables, echo = FALSE, include = FALSE, message = FALSE}

# Distance from conuma

streaminlet$dist.t <- streaminlet$distancefromconuma + 1 
qqp(streaminlet$distancefromconuma, "norm")  # Normal distribution is best fit
qqp(streaminlet$distancefromconuma, "lnorm")
nbinom <- fitdistr(streaminlet$dist.t, "Negative Binomial")
qqp(streaminlet$dist.t, "nbinom", size = nbinom$estimate[[1]], 
    mu = nbinom$estimate[[2]])
poisson <- fitdistr(streaminlet$dist.t, "Poisson")
qqp(streaminlet$dist.t, "pois", lambda = poisson$estimate)

# Total releases from conuma

qqp(totrel$totreleases, "norm")  # Normal distribution is best fit
qqp(totrel$totreleases, "lnorm")
pois <- fitdistr(totrel$totreleases, "Poisson")
qqp(totrel$totreleases, "pois", lambda = poisson$estimate)


```

```{r, Create dataframe for analysis}

modeldat <- join(streaminlet, rpsdat, by = "SYS_NM")

colnames(totrel) <- c("Year", "totalreleases", "totrel.t")

modeldat <- join(totrel, modeldat, by = "Year")

modeldat$logreleases <- log(modeldat$totalreleases)
modeldat$logdistance <- log(modeldat$dist.t)

#modeldat$Year <- as.factor(modeldat$Year)
#modeldat$totalreleases <- as.factor(modeldat$totalreleases)
#modeldat$logreleases <- as.factor(modeldat$logreleases)
#modeldat$distancefromconuma <- as.factor(modeldat$distancefromconuma)
modeldat$SYS_NM <- as.factor(modeldat$SYS_NM)

```

```{r, Model}


# Stream as random effect

mod_stream_log <- lmer(rps ~ logdistance + logreleases + (1 | SYS_NM), 
                   data = modeldat, REML = TRUE)

summary(mod_stream_log)
plot(mod_stream_log) # Residuals fit decently well except at extreme high outliers

qqnorm(resid(mod_stream_log))
qqline(resid(mod_stream_log)) # Model performs well except at extreme high outliers

# Stream + Year as random effect

mod_stream_log <- lmer(rps ~ logdistance + logreleases + (1 | SYS_NM) + (1 | Year), 
                   data = modeldat, REML = TRUE)

summary(mod_stream_log)
plot(mod_stream_log) # Residuals fit decently well except at extreme high outliers

qqnorm(resid(mod_stream_log))
qqline(resid(mod_stream_log)) # Model performs well except at extreme high outliers


```
