---
title: "Area 8 Chum Data Prep"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
#load libraries
knitr::opts_chunk$set(echo = TRUE, fig.pos = "!h")

library(data.table)
library(tidyverse)

options(scipen=10000)

```


```{r functions, echo=FALSE,message=FALSE,warning=FALSE}
#function to extract data and group it

getridofggplotlinesbetweenpoints<-function(data,colstokeep,yearcolumnname) {
  d2<-data%>%select(year=yearcolumnname,colstokeep)
  idx <- c(1, diff(d2$year))
  i2 <- c(1,which(idx != 1), nrow(d2)+1)
  d2$grp <- rep(1:length(diff(i2)), diff(i2))
  d2
}
```



```{r load prep data, echo=FALSE,message=FALSE,warning=FALSE}
#load escapement data and remove 0's

escdata<-fread("data/all nuseds with enhancement rankings.csv")%>%
  select(-V1)

escdata$escapement[escdata$escapement==0]<-NA

escdata<-escdata%>%filter(SPP=="CM"&Area==8)

#write.csv(a25.escdata,"area 25 escapement data all.csv")

# Add filter by year
fy=1980
n.pre=(fy-1953)/2
n.post=(2018-fy)/2

included.stream.list<-esc.data%>%
  mutate(prepost=case_when(Year<1980~"Pre",
                           Year>=1980~"Post"))%>%
  group_by(SYS_NM,prepost)%>%
  summarise(notnas=sum(!is.na(escapement)))%>%
  pivot_wider(names_from="prepost",values_from="notnas")%>%
  filter(Post>n.post&Pre>n.pre)

#add escapement metrics and pre/post field
a25.escdata.filtered<-esc.data%>%filter(SYS_NM%in%included.stream.list$SYS_NM)%>%
  group_by(SYS_NM)%>%
  arrange(SYS_NM,Year)%>%
  mutate(esc.log=log(escapement),
         z=(esc.log-mean(esc.log,na.rm=TRUE))/sd(esc.log,na.rm=TRUE),
         m.ave=rollapply(esc.log,4,mean,align='right',fill=NA),
         esc.stand=esc.log/mean(esc.log,na.rm=TRUE),
         prepost=case_when(Year<1980~"Pre",
                           Year>=1980~"Post"))

write.csv(a25.escdata.filtered,"data/area 25 escapement data filtered.csv")

ggplot(escdata.filt,aes(x=Year,y=escapement,color=Enhancement_Rank))+
  geom_point()+geom_line()+theme_bw()+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  labs(y="Escapement",color="Enhancement Level")+
  theme(legend.position="bottom")

ggsave("figures/a25 chum escapement filtered streams.png",dpi=600,height=8,width=7)

```


```{r junk test}

streaminlet <- read_csv("data/CM A25 filtered stream list_with inlets.csv")

esc.byinlet<-merge(streaminlet,escdata.filt,by="SYS_NM")

escdata.filt.u<-escdata.filt%>%group_by(Enhancement_Rank)

ggplot(esc.byinlet,aes(x=Year,y=z,color=subinlet))+
    geom_point()+
    geom_smooth()
           
           
```




```{r releases for area 8}
releases.raw<-fread("data/AllSEPReleases_2021-01-21 with otoliths revised.csv")

allreleases <- releases.raw %>%
  select(SPECIES_NAME, STOCK_NAME, FACILITY_NAME, RELEASE_SITE_NAME,
         RELEASE_STAGE_NAME, TotalRelease, RELEASE_YEAR, REL_CU_NAME,
         REL_CU_INDEX) %>%
  group_by(SPECIES_NAME,REL_CU_NAME,REL_CU_INDEX,STOCK_NAME,RELEASE_SITE_NAME,
           FACILITY_NAME,RELEASE_STAGE_NAME,RELEASE_YEAR) %>%
  summarise(releases=sum(as.numeric(TotalRelease)),n=n()) %>% 
  ungroup()

allcunames<-allreleases%>%filter(SPECIES_NAME==species)%>%distinct(REL_CU_NAME)
allreleasesites<-allreleases%>%filter(SPECIES_NAME==species&REL_CU_NAME=="")%>%distinct(RELEASE_SITE_NAME,STOCK_NAME)

species="Chum"
rel.cu.name=c("BELLA COOLA RIVER-LATE","BELLA COOLA-DEAN RIVERS","SPILLER-FITZ HUGH-BURKE")

releases <- allreleases %>% 
  data.frame() %>% 
  filter(SPECIES_NAME==species&REL_CU_NAME%in%rel.cu.name)%>%
  mutate("site-stock"=paste0(RELEASE_SITE_NAME,":",STOCK_NAME))%>%
  filter(!is.na(releases))%>%
  arrange(`site-stock`,RELEASE_STAGE_NAME,RELEASE_YEAR)

extra.releasesites<-c("Bella Coola Est","Bella Coola R Low","Bentinck Arm N","Hagensborg Sl","Nooklikonnick Cr")

extras<-allreleases%>%data.frame()%>%
  filter(REL_CU_NAME==""&RELEASE_SITE_NAME%in%extra.releasesites)%>%
  mutate("site-stock"=paste0(RELEASE_SITE_NAME,":",STOCK_NAME))%>%
  filter(!is.na(releases))%>%
  arrange(`site-stock`,RELEASE_STAGE_NAME,RELEASE_YEAR)

releases<-rbind(releases,extras)

idx <- c(1, diff(releases$RELEASE_YEAR))
i2 <- c(1,which(idx != 1), nrow(releases)+1)
releases$grp <- rep(1:length(diff(i2)), diff(i2))

#plot all releases in area to determine which systems specifically to included
ggplot(releases,aes(x=RELEASE_YEAR,y=releases,color=RELEASE_STAGE_NAME,group=grp))+
  geom_line()+geom_point()+
  scale_color_brewer(palette="Set1")+
  facet_wrap(~`site-stock`,ncol=4)+
  theme_bw()+
  labs(x="Release Year",y="Releases",color="Release Stage",
       title=paste0(species,": ",paste0(rel.cu.name,collapse=" ")),subtitle="Release site:Origin stock")+
  theme(legend.position = "bottom",
        plot.title=element_text(size=8),strip.text=element_text(size=8))

#ggsave("figures/releases chum area 8 by CU.png",dpi=600,height=8,width=7)

#write.csv(releases,"data/releases area 8 chum all.csv")

```


```{r total releases for area 8 terminal not including mcloughlin bay}


releasesfortotals<-releases %>% 
  filter(RELEASE_SITE_NAME%in%c("Fish Cr+Airport Ch","Saloompt R","Snootli Cr","Thorsen Cr/CCST"))

totrel <- releasesfortotals %>% 
  group_by(RELEASE_YEAR)%>%
  summarise(totreleases=sum(releases))

write.csv(totrel,"data/releases area 8 chum total terminal releases.csv")

totrel
#write.csv(totrel,"~/R/PSF hatchery review/analysis/spatial/outputs/Area 25 chum releases totals.csv")
```

``` {r prep rps data}
a25.escdata<-fread("data/area 25 escapement data filtered.csv")%>%select(-V1)

age<-fread("data/SCVI_age_2019-04-13.txt")%>%select(-V1)

swvi.ageers<-age%>%filter(CU_Name=="Southwest & West  Vancouver Island")%>%
  select(Year=BroodYear,Total.ER,p3=Age3,p4=Age4,p5=Age5)

a25.rps<-merge(a25.escdata,swvi.ageers,by="Year")%>%
  mutate(TR=escapement/(1-Total.ER))%>%
  mutate(age3=TR*p3,age4=TR*p4,age5=TR*p5)%>%
  mutate(r3=shift(age3,n=-3,type="lag"),r4=shift(age4,n=-4,type="lag"),
         r5=shift(age5,n=-5,type="lag"))%>%
  rowwise()%>%
  mutate(recruits=sum(c_across(r3:r5),na.rm=TRUE))%>%
  mutate(rps=recruits/escapement,
         rps=replace(rps,rps==0,NA),
         logrps=log(rps))

write.csv(a25.rps,"data/area 25 chum rps.csv")

```


```{r}
#total return plot
ggplot(a25.rps,aes(x=Year,y=TR))+
  geom_line()+geom_point()+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")

#rps plots
ggplot(a25.rps,aes(x=Year,y=rps))+
  geom_line()+geom_point()+
  geom_smooth(method='lm',se=TRUE)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_hline(yintercept=1)

#log rps plots
gga25.logrps<-a25.rps%>%select(Year,prepost,logrps,SYS_NM)%>%arrange(SYS_NM,prepost,Year)

idx <- c(1, diff(gga25.logrps$Year))
i2 <- c(1,which(idx != 1), nrow(gga25.logrps)+1)
gga25.logrps$grp <- rep(1:length(diff(i2)), diff(i2))

ggplot(gga25.logrps,aes(x=Year,y=logrps,color=prepost,group=grp))+
  geom_line(alpha=.5)+geom_point(alpha=.5)+
  scale_color_brewer(palette="Set1")+
  geom_smooth(method='lm',se=TRUE)+
  facet_wrap(~SYS_NM,ncol=3,scale="free_y")+
  theme_bw()+
  geom_hline(yintercept=0,linetype="dashed")+
  labs(x="Brood Year",y="log(Recruits per spawner)",color="Period")+
  theme(legend.position="bottom")

ggsave("figures/A25 chum log rps pre vs post.png",dpi=600,height=8,width=7)

ggplot(gga25.logrps,aes(y=SYS_NM,x=logrps,fill=prepost))+
  geom_boxplot(notch=F)+
  scale_fill_brewer(palette="Set1")+
  geom_vline(xintercept=0)+
  theme_bw()+
  labs(y="System Name",x="log(Recruits per spawner)",title="Area 25 Chum")+
  theme(legend.position="bottom")

ggsave("figures/A25 chum log rps pre vs post boxplot.png",dpi=600,height=8,width=7)

```
